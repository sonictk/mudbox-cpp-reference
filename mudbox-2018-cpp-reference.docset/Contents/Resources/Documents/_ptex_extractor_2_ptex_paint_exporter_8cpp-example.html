<!-- saved from url=(0024)http://docs.autodesk.com -->
<html>
<head><script src="../scripts/yepnope.1.5.4-min.js" type="text/javascript"></script><script src="../scripts/lib/jquery-1.11.1.min.js" type="text/javascript"></script><meta content="text/html; charset=utf-8" http-equiv="Content-Type"/><meta content="MOBPRO" name="product"/><meta content="2018" name="release"/><meta content="GeneralUser" name="book"/><meta content="2017-09-08" name="created"/><meta content="GUID-02FA7DD3-6C7A-4C6A-B7BC-824765AE1CB2" name="topicid"/><meta content="concept" name="topic-type"/>
<title>PtexExtractor/PtexPaintExporter.cpp</title>
</head>
<body height="100%"><div class="body_content" id="body-content"><link href="../style/navtree.css" rel="stylesheet" type="text/css"/><link href="../style/doxygen.css" rel="stylesheet" type="text/css"/><link href="../style/tabs.css" rel="stylesheet" type="text/css"/><link href="../style/adsk.cpm.css" rel="stylesheet" type="text/css"/><script language="javascript">var index = 'index.html';</script><script>$(document).ready(function() { yepnope.injectJs("./scripts/ac_common.js"); });</script><script type="text/javascript">
var tocSystemNeedsToBeLoaded = typeof(cpp_ref_adsk_ref_toc) == 'undefined';
var weAreIn21 = $('div#main.view-active').length;
var tocPrefix = '';
if (weAreIn21)
{ tocPrefix = 'cpp_ref/'; }
function cpp_ref_initializeToc(forceTrigger) {
    cpp_ref_adsk_ref_toc.initResizable();
    cpp_ref_adsk_ref_toc.initNavTree('_ptex_extractor_2_ptex_paint_exporter_8cpp-example.html', tocPrefix);
    dQuery(document).trigger('toc_initialized');
}
if (tocSystemNeedsToBeLoaded)
{
	yepnope([{
	load:[tocPrefix + 'json3.min.js', tocPrefix + 'jquery.js', tocPrefix + 'ref-toc-controller.js', tocPrefix + 'dynsections.js'],
	complete: function() {
	  if (typeof(dQuery) == 'undefined')
	  {
	    dQuery = jQuery.noConflict(true);
	  }
	  else { jQuery.noConflict(true); }
	  $(document).ready(cpp_ref_initializeToc);
	}
 	}])
}
if (!weAreIn21) { // if in AKN...
$(window).load( function() {
    setTimeout( function() {
        var content = $('body > div').not('#body-content');     // take any divs under body that are not id=body-content
        content.each( function() { 
            $(this).css( { 'padding-left': $(this).css('margin-left') } );       // and if they have any padding-left already, move it to margin-left.
        } );
        var width = cpp_ref_adsk_ref_toc.readFromStorage('width');
        content.css({marginLeft:parseInt(width)+6+"px"});
    }, 100);
} ); 
}
</script><script>$("div#WidgetFloaterPanels,link[href*='microsofttranslator.com'],script[src*='microsofttranslator.com'],script[src*='bing.com']").remove();</script><script type="text/javascript">$("div#navigation,div#breadcrumbs,div#banner").attr("translate","no"); var mtLocation = ((location && location.href && location.href.indexOf('https') == 0)?'https://ssl.microsofttranslator.com':'http://www.microsofttranslator.com')+'/ajax/v3/WidgetV3.ashx?ctf=True&ui=true&settings=Manual&from=en&hidelanguages='; yepnope.injectJs(mtLocation, function() {}, { charset:'utf-8', type:'text/javascript' } );</script><script>
 if (!tocSystemNeedsToBeLoaded) { cpp_ref_initializeToc(); }
 </script><!-- begin MT -->
<div class="Dark" id="MicrosoftTranslatorWidget" style="float:right;z-index:100;color:white;background-color:#bbbbbb;height:58px;overflow:hidden"></div>
<div>
<div class="head">
<h1>PtexExtractor/PtexPaintExporter.cpp</h1>
</div>
<div id="top"><!-- Generated by Doxygen 1.8.10 -->
<div class="tabs" id="navrow1">
<ul class="tablist">
<li><a href="./index.html"><span>MainÂ Page</span></a></li>
<li><a href="./pages.html"><span>Topics</span></a></li>
<li><a href="./modules.html"><span>Modules</span></a></li>
<li><a href="./namespaces.html"><span>Namespaces</span></a></li>
<li><a href="./annotated.html"><span>Classes</span></a></li>
<li><a href="./files.html"><span>Files</span></a></li>
<li><a href="./examples.html"><span>Examples</span></a></li>
</ul>
</div>
</div><!-- top -->
<div class="ui-resizable side-nav-resizable" id="side-nav">
<div id="nav-tree">
<div id="nav-tree-contents">
<div class="sync" id="nav-sync"></div>
</div>
</div>
<div class="ui-resizable-handle" id="splitbar" style="-moz-user-select:none;">
</div>
</div>
<div id="doc-content">
<div class="header">
<div class="headertitle">
<div class="title">PtexExtractor/PtexPaintExporter.cpp</div> </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"></div>
<div class="line"><span class="comment">//**************************************************************************/</span></div>
<div class="line"><span class="comment">// Copyright (c) 2010 Autodesk, Inc.</span></div>
<div class="line"><span class="comment">// All rights reserved.</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">// Use of this software is subject to the terms of the Autodesk license</span></div>
<div class="line"><span class="comment">// agreement provided at the time of installation or download, or which</span></div>
<div class="line"><span class="comment">// otherwise accompanies this software in either electronic or hard copy form.</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">//**************************************************************************/</span></div>
<div class="line"><span class="comment">// DESCRIPTION:</span></div>
<div class="line"><span class="comment">// CREATED: August 2010</span></div>
<div class="line"><span class="comment">//**************************************************************************/</span></div>
<div class="line"></div>
<div class="line"><span class="comment">// This file makes it possible to export an existing paint layer to a ptex file. It first examines the mesh,</span></div>
<div class="line"><span class="comment">// and if it is possible, it directly saves the texture pieces of a face into the ptex file. Otherwise it does </span></div>
<div class="line"><span class="comment">// a full map extraction process.</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include "PtexPaintExporter.h"</span></div>
<div class="line"><span class="preprocessor">#include "PtexUtilizer.h"</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="./math_8h.html">math.h</a>&gt;</span></div>
<div class="line"></div>
<div class="line"><a name="a0"></a><a class="code" href="./node_8h.html#a1d51ad935ab5d26fe95dff62601b602c">IMPLEMENT_CLASS</a>( PtexPaintExporter, PaintLayerExporter, <span class="stringliteral">"ptexpaintexporter"</span> );</div>
<div class="line"></div>
<div class="line"><a name="a1"></a><a class="code" href="./_g_lee_8h.html#a72ea019df8da89efa294b2beb0ac7b16">Preferences::Bool</a> g_bIncludeBaseMesh(</div>
<div class="line"> <a name="a2"></a><a class="code" href="./i18n_8h.html#aa4e0fec95bdcbdcbe9b3140339e17771">NTR</a>(<span class="stringliteral">"Save mesh data in PTEX files"</span>),</div>
<div class="line"> <a class="code" href="./i18n_8h.html#aa4e0fec95bdcbdcbe9b3140339e17771">NTR</a>(<span class="stringliteral">"Files"</span>),</div>
<div class="line">    QObject::tr(<span class="stringliteral">"Save mesh data in PTEX files"</span>),</div>
<div class="line">    QObject::tr(<span class="stringliteral">"Files"</span>),</div>
<div class="line"> <span class="keyword">true</span> );</div>
<div class="line"></div>
<div class="line"><span class="comment">// The ptex file can contain four different data formats, so four different file types are returned here.</span></div>
<div class="line"><a name="_a3"></a><a class="code" href="./class_q_vector.html">QVector&lt;FileExtension&gt;</a> PtexPaintExporter::SupportedExtensions( <span class="keywordtype">void</span> )<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line"> <a class="code" href="./class_q_vector.html">QVector&lt;FileExtension&gt;</a> <a name="a4"></a><a class="code" href="./_g_lee_8h.html#ad585a1393cfa368fa9dc3d8ebff640d5">s</a>;</div>
<div class="line">    s.<a name="a5"></a><a class="code" href="./class_q_vector.html#ac3da3864dc18a39794b18763448eac3a">append</a>( FileExtension( <span class="stringliteral">"ptx"</span>, QObject::tr(<span class="stringliteral">"Ptex file [8 bit Integer, RGBA]"</span>), Image::e8integer ) );</div>
<div class="line">    s.<a class="code" href="./class_q_vector.html#ac3da3864dc18a39794b18763448eac3a">append</a>( FileExtension( <span class="stringliteral">"ptx"</span>, QObject::tr(<span class="stringliteral">"Ptex file [16 bit Integer, RGBA]"</span>), Image::e16integer ) );</div>
<div class="line">    s.<a class="code" href="./class_q_vector.html#ac3da3864dc18a39794b18763448eac3a">append</a>( FileExtension( <span class="stringliteral">"ptx"</span>, QObject::tr(<span class="stringliteral">"Ptex file [16 bit Floating point, RGBA]"</span>), Image::e16float ) );</div>
<div class="line">    s.<a class="code" href="./class_q_vector.html#ac3da3864dc18a39794b18763448eac3a">append</a>( FileExtension( <span class="stringliteral">"ptx"</span>, QObject::tr(<span class="stringliteral">"Ptex file [32 bit Floating point, RGBA]"</span>), Image::e32float ) );</div>
<div class="line"> <span class="keywordflow">return</span> <a class="code" href="./_g_lee_8h.html#ad585a1393cfa368fa9dc3d8ebff640d5">s</a>;</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line">PtexPaintExporter::PtexPaintExporter() :</div>
<div class="line">m_bUseBaseLevel(this, <a class="code" href="./i18n_8h.html#aa4e0fec95bdcbdcbe9b3140339e17771">NTR</a>(<span class="stringliteral">"Use Base Level"</span>))</div>
<div class="line">{</div>
<div class="line">    m_bUseBaseLevel.SetValue( <span class="keyword">true</span> );</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="comment">// This function exports one paint layer as a ptex file.</span></div>
<div class="line"><span class="keywordtype">void</span> PtexPaintExporter::Export( <span class="keyword">const</span> <a name="_a6"></a><a class="code" href="./class_q_string.html">QString</a> &amp;sFileName, <span class="keywordtype">int</span> iFileTypeIndex, <span class="keyword">const</span> Mesh *pSourceSurface, TexturePool *pSource )</div>
<div class="line">{</div>
<div class="line"> <span class="keywordflow">if</span>( m_bUseBaseLevel )</div>
<div class="line">    {</div>
<div class="line"> <span class="comment">// use the base level of the meshes.</span></div>
<div class="line">        pSourceSurface = pSourceSurface-&gt;Geometry()-&gt;LowestLevel();</div>
<div class="line">    };</div>
<div class="line"></div>
<div class="line"> <span class="comment">// First the function examines the mesh, and if possible, it directly writes the texture pieces for each face</span></div>
<div class="line"> <span class="comment">// into the ptex file. This is only possible if the mesh is a quadric mesh, and the UV for the mesh was generated</span></div>
<div class="line"> <span class="comment">// using the UVlessPainting plugin (in which case each face has a rectangular area on the texture with a size</span></div>
<div class="line"> <span class="comment">// power of two)</span></div>
<div class="line"> <span class="keywordflow">if</span> ( pSourceSurface-&gt;Type() == Mesh::typeQuadric )</div>
<div class="line">    {</div>
<div class="line"> <span class="keyword">const</span> <a name="_a7"></a><a class="code" href="./class_u_v_generator_node.html">UVGeneratorNode</a> *pG = pSourceSurface-&gt;<a name="a8"></a><a class="code" href="./classmudbox_1_1_tree_node.html#a4af55b252dcecf719f083e2ecc16d332">ChildByClass</a>&lt;<a class="code" href="./class_u_v_generator_node.html">UVGeneratorNode</a>&gt;( false );</div>
<div class="line"> <span class="keywordflow">if</span> ( pG )</div>
<div class="line">        {</div>
<div class="line"> <span class="keywordflow">switch</span> ( iFileTypeIndex )</div>
<div class="line">            {</div>
<div class="line"> <span class="keywordflow">case</span> 0:</div>
<div class="line">                FastExport&lt;unsigned char, 255&gt;( sFileName, iFileTypeIndex, pSourceSurface, pSource, pG );</div>
<div class="line"> <span class="keywordflow">return</span>;</div>
<div class="line"> <span class="keywordflow">case</span> 1:</div>
<div class="line">                FastExport&lt;unsigned short, 65525&gt;( sFileName, iFileTypeIndex, pSourceSurface, pSource, pG );</div>
<div class="line"> <span class="keywordflow">return</span>;</div>
<div class="line"> <span class="keywordflow">case</span> 2:</div>
<div class="line">                FastExport&lt;half_, 1&gt;( sFileName, iFileTypeIndex, pSourceSurface, pSource, pG );</div>
<div class="line"> <span class="keywordflow">return</span>;</div>
<div class="line"> <span class="keywordflow">case</span> 3:</div>
<div class="line">                FastExport&lt;float, 1&gt;( sFileName, iFileTypeIndex, pSourceSurface, pSource, pG );</div>
<div class="line"> <span class="keywordflow">return</span>;</div>
<div class="line"> <span class="keywordflow">default</span>:</div>
<div class="line"> <a name="a9"></a><a class="code" href="./mudbox_8h.html#a78d8bd615152a82160d33c6063f0e308">MB_ERROR</a>( <span class="stringliteral">"Unknown filetype"</span> );</div>
<div class="line">            };</div>
<div class="line">        };</div>
<div class="line">    };</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Otherwise, a full map extraction process has to be executed, which extracts the given paint layer into</span></div>
<div class="line"> <span class="comment">// the ptex file.</span></div>
<div class="line">    SubdivisionLevel *pSL = <span class="keyword">dynamic_cast&lt;</span>SubdivisionLevel *<span class="keyword">&gt;</span>( (Mesh *)pSourceSurface );</div>
<div class="line">    SubdivisionLevel *pBL = m_bUseBaseLevel ? pSL-&gt;Geometry()-&gt;LowestLevel() : pSL;</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Create a map extraction node, set all the basic parameters in it.</span></div>
<div class="line">    Instance&lt;MapExtractor&gt; m;</div>
<div class="line">    m-&gt;SetTargetCount( 1 );</div>
<div class="line">    m-&gt;SetTargetMesh( 0, pBL );</div>
<div class="line">    m-&gt;SetSourceCount( 1 );</div>
<div class="line">    m-&gt;SetSourceMesh( 0, pBL-&gt;Geometry()-&gt;HighestLevel() );</div>
<div class="line">    m-&gt;SetUtilizerType( PtexUtilizer::StaticClass() );</div>
<div class="line">    m-&gt;SetLocatorType( ClassDesc::ByName( <a class="code" href="./i18n_8h.html#aa4e0fec95bdcbdcbe9b3140339e17771">NTR</a>( <span class="stringliteral">"SubdivisionLocator"</span> ) ) );</div>
<div class="line"></div>
<div class="line"> <span class="comment">// We only need the paint layer Sampler, so we set the data about the paint layer, and enable it.</span></div>
<div class="line">    Sampler *pC = m-&gt;SamplerByClassName( <span class="stringliteral">"ColorTransfer"</span> );</div>
<div class="line"> <a name="a10"></a><a class="code" href="./mudbox_8h.html#a4574db3fa92e5236e049b3e67bc51cd9">MB_ONBUG</a>( !pC )</div>
<div class="line">        return;</div>
<div class="line"></div>
<div class="line"> <span class="comment">// The paint layer is identified by the name, and the layer index.</span></div>
<div class="line">    Attribute* pTP = pC-&gt;AttributeByID( "texturepool" );</div>
<div class="line"> <a name="a11"></a><a class="code" href="./mudbox_8h.html#a99d9d5b4fd434c7a38c2add8217e4c14">MB_SAFELY</a>( pTP )</div>
<div class="line">        pTP-&gt;SetPointerValue( pSource );</div>
<div class="line">    pC-&gt;SetEnabled( true );</div>
<div class="line"></div>
<div class="line"> <span class="comment">// In the utilizer, we have to set the file name.</span></div>
<div class="line">    Utilizer *pU = pC-&gt;Utilizer();</div>
<div class="line"> <a class="code" href="./mudbox_8h.html#a99d9d5b4fd434c7a38c2add8217e4c14">MB_SAFELY</a>( pU )</div>
<div class="line">    {</div>
<div class="line">        pU-&gt;SetAttributeValue( <span class="stringliteral">"filename"</span>, sFileName );</div>
<div class="line">        pU-&gt;SetAttributeValue( <span class="stringliteral">"includemeshdata"</span>, g_bIncludeBaseMesh ? <span class="stringliteral">"true"</span> : <span class="stringliteral">"false"</span> );</div>
<div class="line">    };</div>
<div class="line"></div>
<div class="line"> <span class="comment">// In the layout we have to set the reolution. This resolution is a guess based on the paint layer</span></div>
<div class="line"> <span class="comment">// resolution and the face count in the base mesh. Ideally the user could control it somehow.</span></div>
<div class="line">    PtexLayout *pPL = <span class="keyword">dynamic_cast&lt;</span>PtexLayout *<span class="keyword">&gt;</span>( m-&gt;Layout() );</div>
<div class="line"> <a class="code" href="./mudbox_8h.html#a99d9d5b4fd434c7a38c2add8217e4c14">MB_SAFELY</a>( pPL )</div>
<div class="line">    {</div>
<div class="line"> <span class="keywordflow">if</span> ( pBL-&gt;UVlessPaintingStatus() == 2 )</div>
<div class="line">            pPL-&gt;m_eDistribution = PtexLayout::distCustom;</div>
<div class="line"> <span class="keywordflow">else</span></div>
<div class="line">        {</div>
<div class="line"> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> iPixelCount = 0;</div>
<div class="line">            for ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="./_g_lee_8h.html#a653819996e713edf9c01a5b564199189">t</a> = 0; <a class="code" href="./_g_lee_8h.html#a653819996e713edf9c01a5b564199189">t</a> &lt; pSource-&gt;TileCount(); <a class="code" href="./_g_lee_8h.html#a653819996e713edf9c01a5b564199189">t</a>++ )</div>
<div class="line">            {</div>
<div class="line"> <span class="keyword">const</span> Texture *pT = pSource-&gt;Tile( <a class="code" href="./_g_lee_8h.html#a653819996e713edf9c01a5b564199189">t</a> );</div>
<div class="line">                iPixelCount += pT-&gt;Width()*pT-&gt;Height();</div>
<div class="line">            };</div>
<div class="line"> <span class="keywordflow">if</span> ( pSource-&gt;TileCount() &gt; 0 )</div>
<div class="line">            {</div>
<div class="line">                pPL-&gt;m_eDistribution = PtexLayout::distUVArea;</div>
<div class="line">                pPL-&gt;m_iDesiredTexelCount = pSource-&gt;Tile( 0 )-&gt;Width()*pSource-&gt;Tile( 0 )-&gt;Height()/2*pSource-&gt;TileCount();</div>
<div class="line">            };</div>
<div class="line">        };</div>
<div class="line">    };</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Set the format of the ptex file.</span></div>
<div class="line">    PtexUtilizer *pPU = <span class="keyword">dynamic_cast&lt;</span>PtexUtilizer *<span class="keyword">&gt;</span>( pU );</div>
<div class="line"> <a class="code" href="./mudbox_8h.html#a99d9d5b4fd434c7a38c2add8217e4c14">MB_SAFELY</a>( pPU )</div>
<div class="line">        pPU-&gt;SetFormat( (PtexUtilizer::Format)iFileTypeIndex );</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Execute the extraction silently.</span></div>
<div class="line">    m-&gt;Execute( false );</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><a name="a12"></a><a class="code" href="./image_8h.html#a00d24c7231be28dbaf71f5408f30e44c">inline</a> <span class="keywordtype">bool</span> isUVRightHanded(const Mesh &amp; mesh, <span class="keywordtype">unsigned</span> <a class="code" href="./_g_lee_8h.html#a676ca580c460c0154eb58200433d2a9e">face</a>) {</div>
<div class="line"> <a name="a13"></a><a class="code" href="./mudbox_8h.html#a24f4fe4a32c8501c3cae26db72954a30">MB_ASSERT</a>(mesh.Type() == Topology::typeQuadric);</div>
<div class="line">    TC o = mesh.QuadVertexTC(face, 0);</div>
<div class="line">    TC <a class="code" href="./_g_lee_8h.html#ac8729153468b5dcf13f971b21d84d4e5">a</a> = mesh.QuadVertexTC(face, 1) - o;</div>
<div class="line">    TC <a class="code" href="./_g_lee_8h.html#a08f98740667f706cd68d5e873088ffa6">b</a> = mesh.QuadVertexTC(face, 3) - o;</div>
<div class="line"> <span class="keywordtype">float</span> zOfCrossProduct = a.u*b.v - b.u*a.v;</div>
<div class="line"> <span class="keywordflow">return</span> zOfCrossProduct &gt; 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// This function export a paint layer to a ptex file by copying rectangular areas from the current texture into the ptex file.</span></div>
<div class="line"><span class="comment">// This is better than a full extraction process, because it is faster, and it preserves the detail (there is no filtering).</span></div>
<div class="line"><span class="keyword">template</span> &lt; <span class="keyword">typename</span> tType, <span class="keywordtype">int</span> iMultiplier &gt;</div>
<div class="line"><span class="keywordtype">void</span> PtexPaintExporter::FastExport( <span class="keyword">const</span> <a class="code" href="./class_q_string.html">QString</a> &amp;sFileName, <span class="keywordtype">int</span> iFileTypeIndex, <span class="keyword">const</span> Mesh *pSourceSurface, TexturePool *pSource, <span class="keyword">const</span> <a class="code" href="./class_u_v_generator_node.html">UVGeneratorNode</a> *pG )</div>
<div class="line">{</div>
<div class="line"> <a name="a14"></a><a class="code" href="./namespacemudbox.html#ae9df9ee935ec6744f98a1585d9db01df">Kernel</a>()-&gt;Interface()-&gt;ProgressStart( QObject::tr(<span class="stringliteral">"Exporting to Ptex file..."</span>), pSourceSurface-&gt;FaceCount() );</div>
<div class="line"> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> iTileWidth = 0, iTileHeight = 0;</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Count the number of tiles in the mesh</span></div>
<div class="line">    AxisAlignedBoundingBox d;</div>
<div class="line"> <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; pSource-&gt;TileCount(); i++ )</div>
<div class="line">        d.Extend( pSource-&gt;TileArea( i ) );</div>
<div class="line"></div>
<div class="line"> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> iXW = ceilf( d.m_vEnd.x ), iYW = ceilf( d.m_vEnd.y );</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Get a copy of the textures as an image, which later can be readed comfortably.</span></div>
<div class="line"> <a class="code" href="./class_q_vector.html">QVector&lt;Image *&gt;</a> aImages( iXW*iYW, NULL );</div>
<div class="line"> <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="./_g_lee_8h.html#a09b61c9254503800358fe9680a997626">x</a> = 0; <a class="code" href="./_g_lee_8h.html#a09b61c9254503800358fe9680a997626">x</a> &lt; iXW; <a class="code" href="./_g_lee_8h.html#a09b61c9254503800358fe9680a997626">x</a>++ )</div>
<div class="line"> <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="./_g_lee_8h.html#af21ddfd4e51a5f5a4d8e60f8b9177b98">y</a> = 0; <a class="code" href="./_g_lee_8h.html#af21ddfd4e51a5f5a4d8e60f8b9177b98">y</a> &lt; iYW; <a class="code" href="./_g_lee_8h.html#af21ddfd4e51a5f5a4d8e60f8b9177b98">y</a>++ )</div>
<div class="line">        {</div>
<div class="line">            Texture *pT = pSource-&gt;Tile( AxisAlignedBoundingBox( Vector( <a class="code" href="./_g_lee_8h.html#a09b61c9254503800358fe9680a997626">x</a>, <a class="code" href="./_g_lee_8h.html#af21ddfd4e51a5f5a4d8e60f8b9177b98">y</a>, 0.5<a class="code" href="./_g_lee_8h.html#a691492ec0bd6383f91200e49f6ae40ed">f</a> ), Vector( <a class="code" href="./_g_lee_8h.html#a09b61c9254503800358fe9680a997626">x</a>+1, <a class="code" href="./_g_lee_8h.html#af21ddfd4e51a5f5a4d8e60f8b9177b98">y</a>+1, 0.5<a class="code" href="./_g_lee_8h.html#a691492ec0bd6383f91200e49f6ae40ed">f</a> ) ) );</div>
<div class="line"> <span class="keywordflow">if</span> ( pT )</div>
<div class="line">            {</div>
<div class="line"> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> iLevel = pT-&gt;getProxyLevel();</div>
<div class="line">                pT-&gt;setProxyLevel(0);</div>
<div class="line">                Image *pI = aImages[<a class="code" href="./_g_lee_8h.html#a09b61c9254503800358fe9680a997626">x</a>+<a class="code" href="./_g_lee_8h.html#af21ddfd4e51a5f5a4d8e60f8b9177b98">y</a>*iXW] = CreateInstance&lt;Image&gt;();</div>
<div class="line">                pT-&gt;CopyTo( pI, <span class="keyword">false</span> );</div>
<div class="line">                pT-&gt;setProxyLevel(iLevel);</div>
<div class="line"></div>
<div class="line"> <span class="keywordflow">if</span> ( iTileWidth == 0 )</div>
<div class="line">                {</div>
<div class="line">                    iTileWidth = pT-&gt;Width();</div>
<div class="line">                    iTileHeight = pT-&gt;Height();</div>
<div class="line">                }</div>
<div class="line"> <span class="keywordflow">else</span> <span class="keywordflow">if</span>( pT-&gt;Location() != TexturePool::locationUnknown &amp;&amp; pT-&gt;Format() != Image::eUnknown )</div>
<div class="line">                {</div>
<div class="line"> <span class="comment">// its possible that pT is an unallocated texture. The reason is that this code assumes the </span></div>
<div class="line"> <span class="comment">// tiles of the texture pool fit perfectly into a rectangle in UV tile space, but that's</span></div>
<div class="line"> <span class="comment">// not always the case. So the uv tile at (x,y) doesn't nessecarily have any texture data </span></div>
<div class="line"> <span class="comment">// allocated for it. So here we'll just check that the valid textures have the same dimensions.</span></div>
<div class="line"> <span class="comment">// (The TexturePool class *is* supposed to just allocate a tile on-demand though</span></div>
<div class="line"> <span class="comment">// I don't know why that isn't working in this case, but anyways, its not a problem here)</span></div>
<div class="line"> <a class="code" href="./mudbox_8h.html#a4574db3fa92e5236e049b3e67bc51cd9">MB_ONBUG</a>( iTileWidth != pT-&gt;Width() || iTileHeight != pT-&gt;Height() )</div>
<div class="line">                    {</div>
<div class="line"> <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j = 0; j &lt; iXW*iYW; j++ )</div>
<div class="line"> <span class="keyword">delete</span> aImages[j];</div>
<div class="line"> <span class="keywordflow">return</span>;</div>
<div class="line">                    };</div>
<div class="line"> <a class="code" href="./mudbox_8h.html#a4574db3fa92e5236e049b3e67bc51cd9">MB_ONBUG</a>( iTileWidth != pI-&gt;Width() || iTileHeight != pI-&gt;Height() )</div>
<div class="line">                    {</div>
<div class="line"> <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j = 0; j &lt; iXW*iYW; j++ )</div>
<div class="line"> <span class="keyword">delete</span> aImages[j];</div>
<div class="line"> <span class="keywordflow">return</span>;</div>
<div class="line">                    };</div>
<div class="line">                };</div>
<div class="line">            };</div>
<div class="line">        };</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Create the ptex file.</span></div>
<div class="line">    Ptex::String sError;</div>
<div class="line"> <a name="_a15"></a><a class="code" href="./class_q_byte_array.html">QByteArray</a> qbaFileMask = <a name="a16"></a><a class="code" href="./class_q_file.html#a548ef3f34e5265ca50980914ccabbfde">QFile::encodeName</a>( sFileName );</div>
<div class="line">    Ptex::DataType aFormats[4] = { Ptex::dt_uint8, Ptex::dt_uint16, Ptex::dt_half, Ptex::dt_float };</div>
<div class="line">    PtexWriter::setTempFolder( <a class="code" href="./namespacemudbox.html#ae9df9ee935ec6744f98a1585d9db01df">Kernel</a>()-&gt;Preferences()-&gt;m_sTempPath.Value().toStdString() );</div>
<div class="line">    PtexWriter *pWriter = PtexWriter::open( qbaFileMask.<a name="a17"></a><a class="code" href="./class_q_byte_array.html#acd2173722996016205933aa3053f895f">constData</a>(), Ptex::mt_quad, aFormats[iFileTypeIndex], 4, 3, pSourceSurface-&gt;FaceCount(), sError );</div>
<div class="line"> <a class="code" href="./mudbox_8h.html#a4574db3fa92e5236e049b3e67bc51cd9">MB_ONBUG</a>( pWriter == NULL || iTileWidth == 0 || iTileHeight == 0 )</div>
<div class="line">    {</div>
<div class="line"> <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j = 0; j &lt; iXW*iYW; j++ )</div>
<div class="line"> <span class="keyword">delete</span> aImages[j];</div>
<div class="line"> <a class="code" href="./namespacemudbox.html#ae9df9ee935ec6744f98a1585d9db01df">Kernel</a>()-&gt;Interface()-&gt;ProgressEnd();</div>
<div class="line"> <span class="keywordflow">return</span>;</div>
<div class="line">    };</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Go through all the faces of the mesh, and for each face, write a ptex face into the file.</span></div>
<div class="line"> <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="./_g_lee_8h.html#a691492ec0bd6383f91200e49f6ae40ed">f</a> = 0; <a class="code" href="./_g_lee_8h.html#a691492ec0bd6383f91200e49f6ae40ed">f</a> &lt; pSourceSurface-&gt;FaceCount(); <a class="code" href="./_g_lee_8h.html#a691492ec0bd6383f91200e49f6ae40ed">f</a>++ )</div>
<div class="line">    {</div>
<div class="line"> <span class="keywordtype">bool</span> swapUV = !isUVRightHanded(*pSourceSurface, <a class="code" href="./_g_lee_8h.html#a691492ec0bd6383f91200e49f6ae40ed">f</a>);</div>
<div class="line"> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> iOrientation = pG-&gt;<a name="a18"></a>FaceOrientation( <a class="code" href="./_g_lee_8h.html#a691492ec0bd6383f91200e49f6ae40ed">f</a> );</div>
<div class="line">        Ptex::FaceInfo sInfo;</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Store the adjacency information for the face. This is used by the ptex library to do filtering at face edges.</span></div>
<div class="line"> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> af[4], ae[4];</div>
<div class="line"> <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> <a class="code" href="./_g_lee_8h.html#a1f2d7f8147412c43ba2303a56f97ee73">c</a> = 0; <a class="code" href="./_g_lee_8h.html#a1f2d7f8147412c43ba2303a56f97ee73">c</a> &lt; 4; <a class="code" href="./_g_lee_8h.html#a1f2d7f8147412c43ba2303a56f97ee73">c</a>++ )</div>
<div class="line">        {</div>
<div class="line"> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> a = pSourceSurface-&gt;QuadAdjacency( <a class="code" href="./_g_lee_8h.html#a691492ec0bd6383f91200e49f6ae40ed">f</a>, <a class="code" href="./_g_lee_8h.html#a1f2d7f8147412c43ba2303a56f97ee73">c</a> );</div>
<div class="line"> <span class="comment">// When the returned value is 0xffffffff it means there is no adjacent face in that direction, so it is an open edge.</span></div>
<div class="line"> <span class="keywordflow">if</span> ( a == 0xffffffff )</div>
<div class="line">            {</div>
<div class="line"> <span class="comment">// When there is no adjacent face, the adjacent face index must be set to -1 (edge index is ignored)</span></div>
<div class="line">                af[<a name="a19"></a><a class="code" href="./_g_lee_8h.html#a1f2d7f8147412c43ba2303a56f97ee73">c</a>] = 0xffffffff;</div>
<div class="line">                ae[<a class="code" href="./_g_lee_8h.html#a1f2d7f8147412c43ba2303a56f97ee73">c</a>] = 0;</div>
<div class="line">            }</div>
<div class="line"> <span class="keywordflow">else</span></div>
<div class="line">            {</div>
<div class="line">                af[<a class="code" href="./_g_lee_8h.html#a1f2d7f8147412c43ba2303a56f97ee73">c</a>] = a/4;</div>
<div class="line">                ae[<a class="code" href="./_g_lee_8h.html#a1f2d7f8147412c43ba2303a56f97ee73">c</a>] = a%4;</div>
<div class="line">            };</div>
<div class="line">        };</div>
<div class="line">        sInfo.setadjfaces( af[0], af[1], af[2], af[3] );</div>
<div class="line">        sInfo.setadjedges( ae[0], ae[1], ae[2], ae[3] );</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Calculate the corners of the texture rectangle.</span></div>
<div class="line"> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> iXS = pG-&gt;<a name="a20"></a>FaceUVPosition(<a class="code" href="./_g_lee_8h.html#a691492ec0bd6383f91200e49f6ae40ed">f</a>)[0];</div>
<div class="line"> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> iYS = pG-&gt;FaceUVPosition(<a class="code" href="./_g_lee_8h.html#a691492ec0bd6383f91200e49f6ae40ed">f</a>)[1];</div>
<div class="line"> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> iXD = pG-&gt;<a name="a21"></a>FaceSizeExponent(<a class="code" href="./_g_lee_8h.html#a691492ec0bd6383f91200e49f6ae40ed">f</a>)[0];</div>
<div class="line"> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> iYD = pG-&gt;FaceSizeExponent(<a class="code" href="./_g_lee_8h.html#a691492ec0bd6383f91200e49f6ae40ed">f</a>)[1];</div>
<div class="line"> <span class="comment">// Calculate the index of the tile</span></div>
<div class="line"> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> iTX = pG-&gt;<a name="a22"></a>FaceUVArea(<a class="code" href="./_g_lee_8h.html#a691492ec0bd6383f91200e49f6ae40ed">f</a>)[0], iTY = pG-&gt;FaceUVArea(<a class="code" href="./_g_lee_8h.html#a691492ec0bd6383f91200e49f6ae40ed">f</a>)[1];</div>
<div class="line">        Image *i = aImages[iTX+iTY*iXW];</div>
<div class="line"> <a class="code" href="./mudbox_8h.html#a4574db3fa92e5236e049b3e67bc51cd9">MB_ONBUG</a>( i == NULL || i-&gt;Width() != pG-&gt;<a name="a23"></a>UVTileSize() || i-&gt;Height() != pG-&gt;UVTileSize() )</div>
<div class="line">        {</div>
<div class="line"> <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j = 0; j &lt; iXW*iYW; j++ )</div>
<div class="line"> <span class="keyword">delete</span> aImages[j];</div>
<div class="line"> <a class="code" href="./namespacemudbox.html#ae9df9ee935ec6744f98a1585d9db01df">Kernel</a>()-&gt;Interface()-&gt;ProgressEnd();</div>
<div class="line"> <a class="code" href="./namespacemudbox.html#ae9df9ee935ec6744f98a1585d9db01df">Kernel</a>()-&gt;Interface()-&gt;SetStatus( Interface::stError, QObject::tr(<span class="stringliteral">"Unknown error exporting ptex file."</span>) );</div>
<div class="line"> <span class="keywordflow">return</span>;</div>
<div class="line">        };</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Based on the orientation of the face, we might have to modify the given values.</span></div>
<div class="line"> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> iXX = 1, iXY = 0, iYX = 0, iYY = 1;</div>
<div class="line"> <span class="keywordflow">if</span> ( swapUV &amp;&amp; iOrientation % 2 )</div>
<div class="line">            iOrientation = 4 - iOrientation;</div>
<div class="line"> <span class="keywordflow">switch</span> ( iOrientation )</div>
<div class="line">        {  </div>
<div class="line"> <span class="keywordflow">case</span> 0:</div>
<div class="line"> <span class="keywordflow">break</span>;</div>
<div class="line"> <span class="keywordflow">case</span> 1:</div>
<div class="line">            {</div>
<div class="line">                iYS += (1&lt;&lt;iXD)-1;</div>
<div class="line"></div>
<div class="line">                iXX = iYY = 0;</div>
<div class="line">                iXY = 1;</div>
<div class="line">                iYX = 0xffffffff;</div>
<div class="line">            };</div>
<div class="line"> <span class="keywordflow">break</span>;</div>
<div class="line"> <span class="keywordflow">case</span> 2:</div>
<div class="line">            iXX = iYY = 0xffffffff;</div>
<div class="line">            iXS += (1&lt;&lt;iXD)-1;</div>
<div class="line">            iYS += (1&lt;&lt;iYD)-1;</div>
<div class="line"> <span class="keywordflow">break</span>;</div>
<div class="line"> <span class="keywordflow">case</span> 3:</div>
<div class="line">            {</div>
<div class="line">                iXS += (1&lt;&lt;iYD)-1;</div>
<div class="line"></div>
<div class="line">                iXX = iYY = 0;</div>
<div class="line">                iXY = 0xffffffff;</div>
<div class="line">                iYX = 1;</div>
<div class="line">            };</div>
<div class="line"> <span class="keywordflow">break</span>;</div>
<div class="line">        };</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Set the size of the face. The width and height of a face can be different, but it is always power of two.</span></div>
<div class="line"> <span class="keywordtype">unsigned</span> iW = swapUV ? 1&lt;&lt;iYD : 1&lt;&lt;iXD,</div>
<div class="line">                 iH = swapUV ? 1&lt;&lt;iXD : 1&lt;&lt;iYD;</div>
<div class="line">        sInfo.res = swapUV ? Ptex::Res( iYD, iXD ) : Ptex::Res( iXD, iYD );</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Allocate a temporary buffer to hold the data.</span></div>
<div class="line">        tType *pData = <span class="keyword">new</span> tType[iW*iH*4];</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Copy the pixels from the texture to the temporary buffer.</span></div>
<div class="line"> <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="./_g_lee_8h.html#af21ddfd4e51a5f5a4d8e60f8b9177b98">y</a> = 0; <a class="code" href="./_g_lee_8h.html#af21ddfd4e51a5f5a4d8e60f8b9177b98">y</a> &lt; iH; <a class="code" href="./_g_lee_8h.html#af21ddfd4e51a5f5a4d8e60f8b9177b98">y</a>++ )</div>
<div class="line"> <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="./_g_lee_8h.html#a09b61c9254503800358fe9680a997626">x</a> = 0; <a class="code" href="./_g_lee_8h.html#a09b61c9254503800358fe9680a997626">x</a> &lt; iW; <a class="code" href="./_g_lee_8h.html#a09b61c9254503800358fe9680a997626">x</a>++ )</div>
<div class="line">            {</div>
<div class="line">                Color <a class="code" href="./_g_lee_8h.html#a1f2d7f8147412c43ba2303a56f97ee73">c</a>;</div>
<div class="line"> <span class="keywordflow">if</span> (swapUV)</div>
<div class="line">                    c = i-&gt;ColorAt( iXS+<a class="code" href="./_g_lee_8h.html#af21ddfd4e51a5f5a4d8e60f8b9177b98">y</a>*iXX+<a class="code" href="./_g_lee_8h.html#a09b61c9254503800358fe9680a997626">x</a>*iXY, iYS+<a class="code" href="./_g_lee_8h.html#af21ddfd4e51a5f5a4d8e60f8b9177b98">y</a>*iYX+<a class="code" href="./_g_lee_8h.html#a09b61c9254503800358fe9680a997626">x</a>*iYY );</div>
<div class="line"> <span class="keywordflow">else</span></div>
<div class="line">                    c = i-&gt;ColorAt( iXS+<a class="code" href="./_g_lee_8h.html#a09b61c9254503800358fe9680a997626">x</a>*iXX+<a class="code" href="./_g_lee_8h.html#af21ddfd4e51a5f5a4d8e60f8b9177b98">y</a>*iXY, iYS+<a class="code" href="./_g_lee_8h.html#a09b61c9254503800358fe9680a997626">x</a>*iYX+<a class="code" href="./_g_lee_8h.html#af21ddfd4e51a5f5a4d8e60f8b9177b98">y</a>*iYY );</div>
<div class="line"> <span class="keywordflow">if</span> ( c.a )</div>
<div class="line">                {</div>
<div class="line"> <span class="keywordtype">float</span> <a class="code" href="./_g_lee_8h.html#a691492ec0bd6383f91200e49f6ae40ed">f</a> = 1/c.a;</div>
<div class="line">                    c.r *= <a name="a24"></a><a class="code" href="./_g_lee_8h.html#a691492ec0bd6383f91200e49f6ae40ed">f</a>;</div>
<div class="line">                    c.g *= <a class="code" href="./_g_lee_8h.html#a691492ec0bd6383f91200e49f6ae40ed">f</a>;</div>
<div class="line">                    c.b *= <a class="code" href="./_g_lee_8h.html#a691492ec0bd6383f91200e49f6ae40ed">f</a>;</div>
<div class="line">                };</div>
<div class="line"> <span class="keywordtype">unsigned</span> <a class="code" href="./_g_lee_8h.html#a6468fe3bfff24d7d939eb21863b88268">index</a> = <a class="code" href="./_g_lee_8h.html#a09b61c9254503800358fe9680a997626">x</a>+<a class="code" href="./_g_lee_8h.html#af21ddfd4e51a5f5a4d8e60f8b9177b98">y</a>*iW;</div>
<div class="line">                pData[index*4+0] = c.r*iMultiplier;</div>
<div class="line">                pData[index*4+1] = c.g*iMultiplier;</div>
<div class="line">                pData[index*4+2] = c.b*iMultiplier;</div>
<div class="line">                pData[index*4+3] = c.a*iMultiplier;</div>
<div class="line">            };</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Write the data to the file, and free the buffer.</span></div>
<div class="line">        pWriter-&gt;writeFace( <a class="code" href="./_g_lee_8h.html#a691492ec0bd6383f91200e49f6ae40ed">f</a>, sInfo, pData );</div>
<div class="line"> <span class="keyword">delete</span> pData;</div>
<div class="line"> <a class="code" href="./namespacemudbox.html#ae9df9ee935ec6744f98a1585d9db01df">Kernel</a>()-&gt;Interface()-&gt;ProgressAdd();</div>
<div class="line">    };</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Close and release the file.</span></div>
<div class="line"> <span class="keywordflow">if</span> ( g_bIncludeBaseMesh )</div>
<div class="line">        PtexUtilizer::WriteMeshData( pWriter, pSourceSurface );</div>
<div class="line">    pWriter-&gt;close( sError );</div>
<div class="line">    pWriter-&gt;release();</div>
<div class="line"></div>
<div class="line"> <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j = 0; j &lt; iXW*iYW; j++ )</div>
<div class="line"> <span class="keyword">delete</span> aImages[j];</div>
<div class="line"></div>
<div class="line"> <a class="code" href="./namespacemudbox.html#ae9df9ee935ec6744f98a1585d9db01df">Kernel</a>()-&gt;Interface()-&gt;ProgressEnd();</div>
<div class="line">};</div>
</div><!-- fragment --> </div><!-- contents -->
</div><!-- doc-content -->
<div class="footer-block"><a class="comments-anchor" href="../html/ac.cmtdialog.htm" target="_blank"><span class="comments-link">Please send us your comment about this page</span></a></div></div>
</div></body>
</html>
