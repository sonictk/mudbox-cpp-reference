<!-- saved from url=(0024)http://docs.autodesk.com -->
<html>
<head><script src="../scripts/yepnope.1.5.4-min.js" type="text/javascript"></script><script src="../scripts/lib/jquery-1.11.1.min.js" type="text/javascript"></script><meta content="text/html; charset=utf-8" http-equiv="Content-Type"/><meta content="MOBPRO" name="product"/><meta content="2018" name="release"/><meta content="GeneralUser" name="book"/><meta content="2017-09-08" name="created"/><meta content="GUID-02FA7DD3-6C7A-4C6A-B7BC-824765AE1CB2" name="topicid"/><meta content="concept" name="topic-type"/>
<title>PtexImporter/PtexImporter.cpp</title>
</head>
<body height="100%"><div class="body_content" id="body-content"><link href="../style/navtree.css" rel="stylesheet" type="text/css"/><link href="../style/doxygen.css" rel="stylesheet" type="text/css"/><link href="../style/tabs.css" rel="stylesheet" type="text/css"/><link href="../style/adsk.cpm.css" rel="stylesheet" type="text/css"/><script language="javascript">var index = 'index.html';</script><script>$(document).ready(function() { yepnope.injectJs("./scripts/ac_common.js"); });</script><script type="text/javascript">
var tocSystemNeedsToBeLoaded = typeof(cpp_ref_adsk_ref_toc) == 'undefined';
var weAreIn21 = $('div#main.view-active').length;
var tocPrefix = '';
if (weAreIn21)
{ tocPrefix = 'cpp_ref/'; }
function cpp_ref_initializeToc(forceTrigger) {
    cpp_ref_adsk_ref_toc.initResizable();
    cpp_ref_adsk_ref_toc.initNavTree('_ptex_importer_2_ptex_importer_8cpp-example.html', tocPrefix);
    dQuery(document).trigger('toc_initialized');
}
if (tocSystemNeedsToBeLoaded)
{
	yepnope([{
	load:[tocPrefix + 'json3.min.js', tocPrefix + 'jquery.js', tocPrefix + 'ref-toc-controller.js', tocPrefix + 'dynsections.js'],
	complete: function() {
	  if (typeof(dQuery) == 'undefined')
	  {
	    dQuery = jQuery.noConflict(true);
	  }
	  else { jQuery.noConflict(true); }
	  $(document).ready(cpp_ref_initializeToc);
	}
 	}])
}
if (!weAreIn21) { // if in AKN...
$(window).load( function() {
    setTimeout( function() {
        var content = $('body > div').not('#body-content');     // take any divs under body that are not id=body-content
        content.each( function() { 
            $(this).css( { 'padding-left': $(this).css('margin-left') } );       // and if they have any padding-left already, move it to margin-left.
        } );
        var width = cpp_ref_adsk_ref_toc.readFromStorage('width');
        content.css({marginLeft:parseInt(width)+6+"px"});
    }, 100);
} ); 
}
</script><script>$("div#WidgetFloaterPanels,link[href*='microsofttranslator.com'],script[src*='microsofttranslator.com'],script[src*='bing.com']").remove();</script><script type="text/javascript">$("div#navigation,div#breadcrumbs,div#banner").attr("translate","no"); var mtLocation = ((location && location.href && location.href.indexOf('https') == 0)?'https://ssl.microsofttranslator.com':'http://www.microsofttranslator.com')+'/ajax/v3/WidgetV3.ashx?ctf=True&ui=true&settings=Manual&from=en&hidelanguages='; yepnope.injectJs(mtLocation, function() {}, { charset:'utf-8', type:'text/javascript' } );</script><script>
 if (!tocSystemNeedsToBeLoaded) { cpp_ref_initializeToc(); }
 </script><!-- begin MT -->

<div>
<div class="head">
<h1>PtexImporter/PtexImporter.cpp</h1>
</div>
<div id="top"><!-- Generated by Doxygen 1.8.10 -->
<div class="tabs" id="navrow1">
<ul class="tablist">
<li><a href="./index.html"><span>MainÂ Page</span></a></li>
<li><a href="./pages.html"><span>Topics</span></a></li>
<li><a href="./modules.html"><span>Modules</span></a></li>
<li><a href="./namespaces.html"><span>Namespaces</span></a></li>
<li><a href="./annotated.html"><span>Classes</span></a></li>
<li><a href="./files.html"><span>Files</span></a></li>
<li><a href="./examples.html"><span>Examples</span></a></li>
</ul>
</div>
</div><!-- top -->
<div class="ui-resizable side-nav-resizable" id="side-nav">
<div id="nav-tree">
<div id="nav-tree-contents">
<div class="sync" id="nav-sync"></div>
</div>
</div>
<div class="ui-resizable-handle" id="splitbar" style="-moz-user-select:none;">
</div>
</div>
<div id="doc-content">
<div class="header">
<div class="headertitle">
<div class="title">PtexImporter/PtexImporter.cpp</div> </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><span class="comment">//**************************************************************************/</span></div>
<div class="line"><span class="comment">// Copyright (c) 2011, 2012 Autodesk, Inc.</span></div>
<div class="line"><span class="comment">// All rights reserved.</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">// Use of this software is subject to the terms of the Autodesk license</span></div>
<div class="line"><span class="comment">// agreement provided at the time of installation or download, or which</span></div>
<div class="line"><span class="comment">// otherwise accompanies this software in either electronic or hard copy form.</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">//**************************************************************************/</span></div>
<div class="line"><span class="comment">// DESCRIPTION: PTEX texture importer</span></div>
<div class="line"><span class="comment">// CREATED: January 2011</span></div>
<div class="line"><span class="comment">//**************************************************************************/</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include "PtexImporter.h"</span> </div>
<div class="line"><span class="preprocessor">#include "PtexPaintLayerImporter.h"</span></div>
<div class="line"></div>
<div class="line"><a name="a0"></a><a class="code" href="./node_8h.html#a1d51ad935ab5d26fe95dff62601b602c">IMPLEMENT_CLASS</a>( PtexImporter, Importer, <span class="stringliteral">"pteximporter"</span> );</div>
<div class="line"></div>
<div class="line"><span class="comment">//------------------------------------------------------------------------------</span></div>
<div class="line"><span class="keywordtype">void</span> PtexImporter::Import( <span class="keyword">const</span> <a name="_a1"></a><a class="code" href="./class_q_string.html">QString</a> &amp;sFileName, Scene::LoadData &amp; )</div>
<div class="line">{</div>
<div class="line"> <a name="_a2"></a><a class="code" href="./classmudbox_1_1_mesh.html">mudbox::Mesh</a> *pMesh = CreateMeshFromPtex( sFileName );</div>
<div class="line"></div>
<div class="line"> <span class="keywordflow">if</span> (!pMesh)</div>
<div class="line"> <span class="keywordflow">return</span>;</div>
<div class="line"></div>
<div class="line">    PtexPaintLayerImporter *pI = CreateInstance&lt;PtexPaintLayerImporter&gt;();</div>
<div class="line"></div>
<div class="line"> <span class="keywordflow">if</span> (pI) {</div>
<div class="line">        pI-&gt;SetPtexImporter(<span class="keyword">this</span>);</div>
<div class="line">        pI-&gt;Prepare( sFileName, pMesh, <span class="keyword">false</span>, <span class="keyword">true</span> );</div>
<div class="line">        pI-&gt;Import( sFileName, 0, pMesh, 0 );</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"> <span class="keywordflow">if</span> (m_FaceMap != 0) {</div>
<div class="line"> <span class="keyword">delete</span> [] m_FaceMap;</div>
<div class="line">        m_FaceMap = 0;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"> <span class="keywordflow">if</span> (m_ReverseFaceMap != 0) {</div>
<div class="line"> <span class="keyword">delete</span> [] m_ReverseFaceMap;</div>
<div class="line">        m_ReverseFaceMap = 0;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="comment">//------------------------------------------------------------------------------</span></div>
<div class="line">Mesh *PtexImporter::CreateMeshFromPtex( <span class="keyword">const</span> <a class="code" href="./class_q_string.html">QString</a> &amp;sFileName, </div>
<div class="line"> <span class="keywordtype">bool</span> makeMesh, <span class="keywordtype">bool</span> silent )</div>
<div class="line">{</div>
<div class="line"> <span class="keywordflow">if</span> (m_FaceMap != 0) {</div>
<div class="line"> <span class="keyword">delete</span> [] m_FaceMap;</div>
<div class="line">        m_FaceMap = 0;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"> <span class="keywordflow">if</span> (m_ReverseFaceMap != 0) {</div>
<div class="line"> <span class="keyword">delete</span> [] m_ReverseFaceMap;</div>
<div class="line">        m_ReverseFaceMap = 0;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    Ptex::String   <a name="a3"></a><a class="code" href="./_g_lee_8h.html#ad585a1393cfa368fa9dc3d8ebff640d5">s</a>;</div>
<div class="line"> <a name="_a4"></a><a class="code" href="./class_q_byte_array.html">QByteArray</a> <a class="code" href="./_g_lee_8h.html#ac8729153468b5dcf13f971b21d84d4e5">a</a> = <a name="a5"></a><a class="code" href="./class_q_file.html#a548ef3f34e5265ca50980914ccabbfde">QFile::encodeName</a>( sFileName );</div>
<div class="line">    PtexTexture  *pT = PtexTexture::open( a.<a name="a6"></a><a class="code" href="./class_q_byte_array.html#acd2173722996016205933aa3053f895f">constData</a>(), <a class="code" href="./_g_lee_8h.html#ad585a1393cfa368fa9dc3d8ebff640d5">s</a> );</div>
<div class="line"></div>
<div class="line"> <span class="keywordflow">if</span> (!pT) {</div>
<div class="line"> <a name="a7"></a><a class="code" href="./namespacemudbox.html#ae9df9ee935ec6744f98a1585d9db01df">Kernel</a>()-&gt;Interface()-&gt;HUDMessageShow( tr(<span class="stringliteral">"Unable to open PTEX file. Mudbox cannot import it."</span>),  </div>
<div class="line"> <a name="a8"></a><a class="code" href="./classmudbox_1_1_interface.html#a26e31204f799b1a1db85565fc5a98b99a6d1628d017e93eb59b9a74b0cdc9d904">mudbox::Interface::HUDmsgFade</a> );</div>
<div class="line"> <a class="code" href="./namespacemudbox.html#ae9df9ee935ec6744f98a1585d9db01df">Kernel</a>()-&gt;Log( <a class="code" href="./class_q_string.html">QString</a>( <span class="stringliteral">"Unable to open PTEX file. Mudbox cannot import it.\n"</span> ));</div>
<div class="line"> <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"> <span class="keywordflow">if</span> (pT-&gt;meshType() != Ptex::mt_quad) {</div>
<div class="line"> <a class="code" href="./namespacemudbox.html#ae9df9ee935ec6744f98a1585d9db01df">Kernel</a>()-&gt;Interface()-&gt;HUDMessageShow( tr(<span class="stringliteral">"This PTEX file is not quadrangular. "</span></div>
<div class="line"> <span class="stringliteral">"Mudbox cannot import it."</span>),  </div>
<div class="line"> <a class="code" href="./classmudbox_1_1_interface.html#a26e31204f799b1a1db85565fc5a98b99a6d1628d017e93eb59b9a74b0cdc9d904">mudbox::Interface::HUDmsgFade</a> );</div>
<div class="line"> <a class="code" href="./namespacemudbox.html#ae9df9ee935ec6744f98a1585d9db01df">Kernel</a>()-&gt;Log( <a class="code" href="./class_q_string.html">QString</a>( <span class="stringliteral">"This PTEX file is not quadrangular. Mudbox cannot import it.\n"</span> ));</div>
<div class="line">        pT-&gt;release();</div>
<div class="line"> <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    PtexMetaData *pM = pT-&gt;getMetaData();</div>
<div class="line"> <span class="keywordflow">if</span> ( !pM ) </div>
<div class="line">    {</div>
<div class="line"> <a class="code" href="./namespacemudbox.html#ae9df9ee935ec6744f98a1585d9db01df">Kernel</a>()-&gt;Log(<a class="code" href="./class_q_string.html">QString</a>(<span class="stringliteral">"This PTEX file does not contain mesh information. Mudbox cannot import it."</span>));  </div>
<div class="line"> <span class="keywordflow">if</span> (!silent) {</div>
<div class="line"> <a class="code" href="./namespacemudbox.html#ae9df9ee935ec6744f98a1585d9db01df">Kernel</a>()-&gt;Interface()-&gt;HUDMessageShow( tr(<span class="stringliteral">"This PTEX file does not contain mesh information. "</span></div>
<div class="line"> <span class="stringliteral">"Mudbox cannot import it."</span>),  </div>
<div class="line"> <a class="code" href="./classmudbox_1_1_interface.html#a26e31204f799b1a1db85565fc5a98b99a6d1628d017e93eb59b9a74b0cdc9d904">mudbox::Interface::HUDmsgFade</a> );</div>
<div class="line">        }</div>
<div class="line"> <span class="keywordflow">return</span> NULL;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    m_iFaceCount = 0;</div>
<div class="line"> <span class="keyword">const</span> <span class="keywordtype">int</span> *aFaceSizes = NULL;</div>
<div class="line">    pM-&gt;getValue( <a name="a9"></a><a class="code" href="./i18n_8h.html#aa4e0fec95bdcbdcbe9b3140339e17771">NTR</a>(<span class="stringliteral">"PtexFaceVertCounts"</span>), aFaceSizes, m_iFaceCount );</div>
<div class="line"> <span class="keywordflow">if</span> ( aFaceSizes == NULL )</div>
<div class="line">    {</div>
<div class="line"> <a class="code" href="./namespacemudbox.html#ae9df9ee935ec6744f98a1585d9db01df">Kernel</a>()-&gt;Log(<a class="code" href="./i18n_8h.html#aa4e0fec95bdcbdcbe9b3140339e17771">NTR</a>(<span class="stringliteral">"This PTEX file does not contain mesh information. "</span></div>
<div class="line"> <span class="stringliteral">"Mudbox cannot import it. (2)"</span>));</div>
<div class="line"> <span class="keywordflow">if</span> (!silent) {</div>
<div class="line"> <a class="code" href="./namespacemudbox.html#ae9df9ee935ec6744f98a1585d9db01df">Kernel</a>()-&gt;Interface()-&gt;HUDMessageShow( tr(<span class="stringliteral">"This PTEX file does not contain mesh information. "</span></div>
<div class="line"> <span class="stringliteral">"Mudbox cannot import it."</span>),  </div>
<div class="line"> <a class="code" href="./classmudbox_1_1_interface.html#a26e31204f799b1a1db85565fc5a98b99a6d1628d017e93eb59b9a74b0cdc9d904">mudbox::Interface::HUDmsgFade</a> );</div>
<div class="line">        }</div>
<div class="line"> <span class="keywordflow">return</span> NULL;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"> <span class="keywordtype">int</span> pTexSubFaceCount = pT-&gt;numFaces();</div>
<div class="line"></div>
<div class="line">    memset(m_hist, 0, <span class="keyword">sizeof</span>(m_hist));                                </div>
<div class="line">    m_allQuads    = <span class="keyword">true</span>;</div>
<div class="line">    m_maxFaceSize = 0;</div>
<div class="line">    m_minFaceSize = INT_MAX;</div>
<div class="line">    m_iTotalTesselatedFaceCount = 0;</div>
<div class="line"></div>
<div class="line"> <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i = 0; i &lt; m_iFaceCount; i++ ) {</div>
<div class="line"> <span class="keywordtype">int</span> faceSize = aFaceSizes[i];</div>
<div class="line"> <span class="keywordflow">if</span> (faceSize &lt; MAX_EDGE_COUNT) { </div>
<div class="line">            ++m_hist[faceSize];</div>
<div class="line">        } <span class="keywordflow">else</span> {</div>
<div class="line"> <a class="code" href="./namespacemudbox.html#ae9df9ee935ec6744f98a1585d9db01df">Kernel</a>()-&gt;Log( <a name="a10"></a><a class="code" href="./i18n_8h.html#a1b7f65502ea5b58cca15f85d9e78ca06">NTRQ</a>(<span class="stringliteral">"Mudbox can only import PTEX files that "</span></div>
<div class="line"> <span class="stringliteral">"contain faces with less than %1 sides"</span>).arg(MAX_EDGE_COUNT));</div>
<div class="line"> <span class="keywordflow">if</span> (!silent) {</div>
<div class="line"> <a class="code" href="./namespacemudbox.html#ae9df9ee935ec6744f98a1585d9db01df">Kernel</a>()-&gt;Interface()-&gt;HUDMessageShow( tr(<span class="stringliteral">"Mudbox can only import PTEX files "</span></div>
<div class="line"> <span class="stringliteral">"that contain faces with less than %1 sides"</span>)</div>
<div class="line">                                                       .arg(MAX_EDGE_COUNT),  </div>
<div class="line"> <a class="code" href="./classmudbox_1_1_interface.html#a26e31204f799b1a1db85565fc5a98b99a6d1628d017e93eb59b9a74b0cdc9d904">mudbox::Interface::HUDmsgFade</a> );</div>
<div class="line">            }</div>
<div class="line"> <span class="keywordflow">return</span> NULL;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line"> <span class="keywordflow">if</span> (faceSize &lt; 3) {</div>
<div class="line"> <a class="code" href="./namespacemudbox.html#ae9df9ee935ec6744f98a1585d9db01df">Kernel</a>()-&gt;Log(<a class="code" href="./i18n_8h.html#aa4e0fec95bdcbdcbe9b3140339e17771">NTR</a>(<span class="stringliteral">"Mudbox can only import PTEX files that contain faces with at least 3 sides"</span>));</div>
<div class="line"> <span class="keywordflow">if</span> (!silent) {</div>
<div class="line"> <a class="code" href="./namespacemudbox.html#ae9df9ee935ec6744f98a1585d9db01df">Kernel</a>()-&gt;Interface()-&gt;HUDMessageShow( tr(<span class="stringliteral">"Mudbox can only import PTEX files that "</span></div>
<div class="line"> <span class="stringliteral">"contain faces with at least 3 sides"</span>),  </div>
<div class="line"> <a class="code" href="./classmudbox_1_1_interface.html#a26e31204f799b1a1db85565fc5a98b99a6d1628d017e93eb59b9a74b0cdc9d904">mudbox::Interface::HUDmsgFade</a> );</div>
<div class="line">            }</div>
<div class="line"> <span class="keywordflow">return</span> NULL;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line"> <span class="keywordflow">if</span> (faceSize != 4)            m_allQuads    = <span class="keyword">false</span>;</div>
<div class="line"> <span class="keywordflow">if</span> (faceSize &gt; m_maxFaceSize) m_maxFaceSize = faceSize;</div>
<div class="line"> <span class="keywordflow">if</span> (faceSize &lt; m_minFaceSize) m_minFaceSize = faceSize;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"> <span class="keywordflow">if</span> (m_allQuads) {</div>
<div class="line">        m_iTotalTesselatedFaceCount = m_iFaceCount;</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line"> <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 3; i &lt; m_maxFaceSize+1; ++i) {</div>
<div class="line">            m_iTotalTesselatedFaceCount += (m_hist[i] * (i - 2)); </div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"> <a class="code" href="./namespacemudbox.html#ae9df9ee935ec6744f98a1585d9db01df">Kernel</a>()-&gt;Log(<span class="stringliteral">"\nPTex Import VertexCount Histogram;\n"</span>);</div>
<div class="line"></div>
<div class="line"> <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; MAX_EDGE_COUNT; ++i) {</div>
<div class="line"> <span class="keywordflow">if</span> (m_hist[i] != 0) {</div>
<div class="line"> <a class="code" href="./namespacemudbox.html#ae9df9ee935ec6744f98a1585d9db01df">Kernel</a>()-&gt;Log(<a class="code" href="./class_q_string.html">QString</a>(<span class="stringliteral">"    Vertex Count %1, number of faces %2\n"</span>).arg(i).arg(m_hist[i]));</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> <a class="code" href="./namespacemudbox.html#ae9df9ee935ec6744f98a1585d9db01df">Kernel</a>()-&gt;Log(<span class="stringliteral">"\n"</span>);</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Read vertex positions</span></div>
<div class="line"> <span class="keywordtype">int</span> iVertexDataSize = 0;</div>
<div class="line"> <span class="keyword">const</span> <span class="keywordtype">float</span> *aVertexPositions = NULL;</div>
<div class="line">    pM-&gt;getValue( <a class="code" href="./i18n_8h.html#aa4e0fec95bdcbdcbe9b3140339e17771">NTR</a>(<span class="stringliteral">"PtexVertPositions"</span>), aVertexPositions, iVertexDataSize );</div>
<div class="line"></div>
<div class="line"> <span class="keywordflow">if</span> ( iVertexDataSize%3 || aVertexPositions == NULL ) {</div>
<div class="line"> <a class="code" href="./namespacemudbox.html#ae9df9ee935ec6744f98a1585d9db01df">Kernel</a>()-&gt;Log(<a class="code" href="./class_q_string.html">QString</a>(<span class="stringliteral">"Ptex: Vertex DataSize %1, \n"</span>).arg(iVertexDataSize));</div>
<div class="line"> <span class="keywordflow">return</span> NULL;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"> <span class="keywordtype">int</span>           iFaceDataSize = 0;</div>
<div class="line"> <span class="keyword">const</span> <span class="keywordtype">int</span>    *aFaceData     = NULL;</div>
<div class="line"> <a class="code" href="./classmudbox_1_1_mesh.html">mudbox::Mesh</a> *pMesh         = NULL;</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Read face indices</span></div>
<div class="line">    pM-&gt;getValue( <a class="code" href="./i18n_8h.html#aa4e0fec95bdcbdcbe9b3140339e17771">NTR</a>(<span class="stringliteral">"PtexFaceVertIndices"</span>), aFaceData, iFaceDataSize );</div>
<div class="line"></div>
<div class="line"> <span class="keywordflow">if</span> ( aFaceData == NULL )</div>
<div class="line"> <span class="keywordflow">return</span> NULL;</div>
<div class="line"></div>
<div class="line"> <a class="code" href="./namespacemudbox.html#ae9df9ee935ec6744f98a1585d9db01df">Kernel</a>()-&gt;Log(<a class="code" href="./class_q_string.html">QString</a>(<span class="stringliteral">"Ptex: Max Face Size %5, VertexCount %3, FaceCount %1, "</span></div>
<div class="line"> <span class="stringliteral">"TesselatedFaceCount = %4, FakeTriangleCount %2\n\n"</span>).</div>
<div class="line">                          arg(m_iFaceCount).arg(m_iTotalTesselatedFaceCount - m_iFaceCount).</div>
<div class="line">                          arg(iVertexDataSize/3).</div>
<div class="line">                          arg(m_iTotalTesselatedFaceCount).arg(m_maxFaceSize));</div>
<div class="line"></div>
<div class="line"> </div>
<div class="line"> <span class="comment">// Create the mesh, and fill the vertex position and face index data.</span></div>
<div class="line"> <span class="keywordflow">if</span> (makeMesh) {</div>
<div class="line"> <span class="keywordflow">if</span> (m_allQuads) {</div>
<div class="line">            pMesh = <a class="code" href="./namespacemudbox.html#ae9df9ee935ec6744f98a1585d9db01df">Kernel</a>()-&gt;Scene()-&gt;CreateMesh( Topology::typeQuadric );</div>
<div class="line">        } <span class="keywordflow">else</span> {</div>
<div class="line">            pMesh = <a class="code" href="./namespacemudbox.html#ae9df9ee935ec6744f98a1585d9db01df">Kernel</a>()-&gt;Scene()-&gt;CreateMesh( Topology::typeTriangular );</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line"> <span class="comment">// if the mesh is not all quads, Mudbox wants it tessellated into triangles.</span></div>
<div class="line"> <span class="comment">// each n-gon becomes n-2 triangles. The first triangle of an n-gon is "real"</span></div>
<div class="line"> <span class="comment">// the rest are "fake"</span></div>
<div class="line"></div>
<div class="line"> <a name="a11"></a><a class="code" href="./mudbox_8h.html#a24f4fe4a32c8501c3cae26db72954a30">MB_ASSERT</a>(m_iTotalTesselatedFaceCount &gt;= m_iFaceCount);</div>
<div class="line"></div>
<div class="line"> <span class="keywordflow">if</span> (pMesh) {</div>
<div class="line">        pMesh-&gt;<a name="a12"></a><a class="code" href="./classmudbox_1_1_topology.html#ac8eb33fd4176fbcf3a49dd96f94be339">SetFaceCount</a>( m_iTotalTesselatedFaceCount );</div>
<div class="line"></div>
<div class="line">        pMesh-&gt;<a name="a13"></a><a class="code" href="./classmudbox_1_1_mesh.html#acce0c98815a83a951ca634dbe39e2e24">SetVertexCount</a>( iVertexDataSize/3 );</div>
<div class="line"> <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i = 0; i &lt; iVertexDataSize/3; i++ ) {</div>
<div class="line">                pMesh-&gt;<a name="a14"></a><a class="code" href="./classmudbox_1_1_mesh.html#aa0fb4993513e43516770e8a0e7386712">SetVertexPosition</a>( i, Vector( aVertexPositions[i*3+0], </div>
<div class="line">                                                     aVertexPositions[i*3+1], </div>
<div class="line">                                                     aVertexPositions[i*3+2] ) );</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line"> <span class="keywordflow">if</span> (!m_allQuads) {</div>
<div class="line">            pMesh-&gt;<a name="a15"></a><a class="code" href="./classmudbox_1_1_topology.html#abd05a8feac402aa9e6bb107ccf282736">SetFakeTriangleCount</a>(m_iTotalTesselatedFaceCount - m_iFaceCount);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line"> <a name="_a16"></a><a class="code" href="./class_q_file_info.html">QFileInfo</a> cFileInfo( sFileName );</div>
<div class="line">        pMesh-&gt;<a name="a17"></a><a class="code" href="./classmudbox_1_1_node.html#abbcb71bef5b8aa8a2a9fe8997eb04711">SetName</a>( cFileInfo.baseName().isEmpty() ? <a class="code" href="./i18n_8h.html#aa4e0fec95bdcbdcbe9b3140339e17771">NTR</a>(<span class="stringliteral">"PTEX_Mesh"</span>) : cFileInfo.baseName() );</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"> <span class="keywordtype">int</span> curTri       = 0;                                           </div>
<div class="line"> <span class="keywordtype">int</span> curVertex    = 0;</div>
<div class="line"> <span class="keywordtype">int</span> curSubFaceID = 0;</div>
<div class="line"></div>
<div class="line">    m_FaceMap        = <span class="keyword">new</span> FaceMapEntry[m_iFaceCount];</div>
<div class="line">    m_ReverseFaceMap = <span class="keyword">new</span> <span class="keywordtype">int</span>[m_iTotalTesselatedFaceCount];</div>
<div class="line">    memset(m_ReverseFaceMap, 0, m_iTotalTesselatedFaceCount * <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));</div>
<div class="line"> </div>
<div class="line"> <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i = 0; i &lt; m_iFaceCount; i++ )</div>
<div class="line">    {</div>
<div class="line"> <span class="keywordflow">if</span> (m_allQuads) {</div>
<div class="line"></div>
<div class="line"> <span class="keywordflow">if</span> (pMesh) {</div>
<div class="line">                pMesh-&gt;<a name="a18"></a><a class="code" href="./classmudbox_1_1_topology.html#a6134366cd9bdad39c85e80a1853189c9">SetQuadIndex</a>( i, 0, aFaceData[i * 4 + 0] );</div>
<div class="line">                pMesh-&gt;<a class="code" href="./classmudbox_1_1_topology.html#a6134366cd9bdad39c85e80a1853189c9">SetQuadIndex</a>( i, 1, aFaceData[i * 4 + 1] );</div>
<div class="line">                pMesh-&gt;<a class="code" href="./classmudbox_1_1_topology.html#a6134366cd9bdad39c85e80a1853189c9">SetQuadIndex</a>( i, 2, aFaceData[i * 4 + 2] );          </div>
<div class="line">                pMesh-&gt;<a class="code" href="./classmudbox_1_1_topology.html#a6134366cd9bdad39c85e80a1853189c9">SetQuadIndex</a>( i, 3, aFaceData[i * 4 + 3] );</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            m_FaceMap[i].m_NumEdges            = 4;</div>
<div class="line">            m_FaceMap[i].m_NumTessellatedFaces = 1;</div>
<div class="line">            m_FaceMap[i].m_MBFaceID            = i;</div>
<div class="line">            m_FaceMap[i].m_PTexSubfaceID       = curSubFaceID;</div>
<div class="line">            m_ReverseFaceMap[i]                = i;</div>
<div class="line"></div>
<div class="line">            curSubFaceID                      += 1; <span class="comment">// quads are 1 face.</span></div>
<div class="line"></div>
<div class="line">        } <span class="keywordflow">else</span> {</div>
<div class="line"> <span class="keyword">const</span> <span class="keywordtype">int</span>  faceSize      = aFaceSizes[i];</div>
<div class="line"> <span class="keywordtype">int</span>        subTri        = 0;</div>
<div class="line"></div>
<div class="line">            m_FaceMap[i].m_NumEdges  = faceSize;</div>
<div class="line">            m_FaceMap[i].m_MBFaceID  = curTri;</div>
<div class="line">            m_ReverseFaceMap[curTri] = i;</div>
<div class="line"></div>
<div class="line"> <span class="keywordflow">if</span> (pMesh) {</div>
<div class="line">                pMesh-&gt;<a name="a19"></a><a class="code" href="./classmudbox_1_1_topology.html#aef15606384943e298d2f67a04fbf770c">SetTriangleIndex</a>( curTri, 0, aFaceData[curVertex + 0] );</div>
<div class="line">                pMesh-&gt;<a class="code" href="./classmudbox_1_1_topology.html#aef15606384943e298d2f67a04fbf770c">SetTriangleIndex</a>( curTri, 1, aFaceData[curVertex + 1] );</div>
<div class="line">                pMesh-&gt;<a class="code" href="./classmudbox_1_1_topology.html#aef15606384943e298d2f67a04fbf770c">SetTriangleIndex</a>( curTri, 2, aFaceData[curVertex + 2] );</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            ++curTri; ++subTri;</div>
<div class="line"> <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 3; j &lt; faceSize; ++j) {</div>
<div class="line">                m_ReverseFaceMap[curTri] = i;</div>
<div class="line"> <span class="keywordflow">if</span> (pMesh) {</div>
<div class="line">                    pMesh-&gt;<a class="code" href="./classmudbox_1_1_topology.html#aef15606384943e298d2f67a04fbf770c">SetTriangleIndex</a>( curTri, 0, aFaceData[curVertex + 0    ] );</div>
<div class="line">                    pMesh-&gt;<a class="code" href="./classmudbox_1_1_topology.html#aef15606384943e298d2f67a04fbf770c">SetTriangleIndex</a>( curTri, 1, aFaceData[curVertex + j - 1] );</div>
<div class="line">                    pMesh-&gt;<a class="code" href="./classmudbox_1_1_topology.html#aef15606384943e298d2f67a04fbf770c">SetTriangleIndex</a>( curTri, 2, aFaceData[curVertex + j    ] );</div>
<div class="line">                    pMesh-&gt;<a name="a20"></a><a class="code" href="./classmudbox_1_1_topology.html#a13daf37a4d363e3880b3a663e3faf6fe">SetFakeTriangle</a>(curTri, <span class="keyword">true</span>);</div>
<div class="line">                }</div>
<div class="line">                ++curTri; ++subTri;</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            curVertex += faceSize;</div>
<div class="line"></div>
<div class="line">            m_FaceMap[i].m_NumTessellatedFaces = subTri;</div>
<div class="line">            m_FaceMap[i].m_PTexSubfaceID       = curSubFaceID;</div>
<div class="line"></div>
<div class="line"> <span class="comment">// if it's a quad, it's one face, if it's an n-gon, it's n quadrangular subfaces.</span></div>
<div class="line"> <span class="comment">// (of course, we've tessellated that into n-2 triangles) </span></div>
<div class="line">            curSubFaceID += (faceSize == 4) ? 1 : faceSize;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    m_iSubFaceCount = curSubFaceID;</div>
<div class="line"></div>
<div class="line"> <a class="code" href="./namespacemudbox.html#ae9df9ee935ec6744f98a1585d9db01df">Kernel</a>()-&gt;Log(<a class="code" href="./class_q_string.html">QString</a>(<span class="stringliteral">"Ptex: Computed subface count = %1, actual in file = %2\n"</span>).</div>
<div class="line">                          arg(m_iSubFaceCount).arg(pTexSubFaceCount));</div>
<div class="line"></div>
<div class="line"> <span class="keywordflow">if</span> (pMesh) {</div>
<div class="line">        pMesh-&gt;<a name="a21"></a><a class="code" href="./classmudbox_1_1_mesh.html#a57ffbe5c13bcfe051e767d418c856225">RecalculateAdjacency</a>(<span class="keyword">false</span>);</div>
<div class="line"></div>
<div class="line">        AddMesh( pMesh );</div>
<div class="line"></div>
<div class="line">        Material *pMat = CreateInstance&lt;Material&gt;();</div>
<div class="line">        pMesh-&gt;<a name="a22"></a><a class="code" href="./classmudbox_1_1_mesh.html#a2f4411607821e44bb787f46d6f84775a">Geometry</a>()-&gt;<a name="a23"></a><a class="code" href="./classmudbox_1_1_geometry.html#adb9f684a165c4f8a1c4c4579a211d19b">SetMaterial</a>( pMat );</div>
<div class="line"> <a class="code" href="./namespacemudbox.html#ae9df9ee935ec6744f98a1585d9db01df">Kernel</a>()-&gt;Scene()-&gt;AddChild( pMat );</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    pT-&gt;release();                              </div>
<div class="line"></div>
<div class="line"> <span class="keywordflow">return</span> pMesh;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="comment">//------------------------------------------------------------------------------</span></div>
<div class="line"><span class="keywordtype">void</span>  PtexImporter::BuildMapsFromBaseMesh(Mesh *pMesh)</div>
<div class="line">{</div>
<div class="line"> <span class="keywordflow">if</span> (!pMesh) </div>
<div class="line"> <span class="keywordflow">return</span>;</div>
<div class="line"></div>
<div class="line"> <span class="keywordtype">int</span> polyCount = pMesh-&gt;<a name="a24"></a><a class="code" href="./classmudbox_1_1_topology.html#a0e35b2c17d86dbf3d35d45e055f1954d">FaceCount</a>();</div>
<div class="line"></div>
<div class="line"> <span class="keywordflow">if</span> ((pMesh-&gt;Type() == Topology::typeQuadric)) {</div>
<div class="line"> <span class="comment">// handle the simple 1:1 case of an all quad mesh;</span></div>
<div class="line">        m_allQuads       = <span class="keyword">true</span>;</div>
<div class="line">        m_maxFaceSize    = 4;</div>
<div class="line">        m_minFaceSize    = 4;</div>
<div class="line">        m_hist[4]        = polyCount;</div>
<div class="line">        m_iFaceCount     = m_iTotalTesselatedFaceCount = m_iSubFaceCount = polyCount;</div>
<div class="line">        m_FaceMap        = <span class="keyword">new</span> FaceMapEntry[m_iFaceCount];</div>
<div class="line">        m_ReverseFaceMap = <span class="keyword">new</span> <span class="keywordtype">int</span>[m_iTotalTesselatedFaceCount];</div>
<div class="line"> <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; polyCount; ++i) {</div>
<div class="line">            m_FaceMap[i].m_NumEdges            = 4;</div>
<div class="line">            m_FaceMap[i].m_MBFaceID            = i;        </div>
<div class="line">            m_FaceMap[i].m_PTexSubfaceID       = i;</div>
<div class="line">            m_FaceMap[i].m_NumTessellatedFaces = 1;</div>
<div class="line">            m_ReverseFaceMap[i]                = i; </div>
<div class="line">        }   </div>
<div class="line"></div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        m_allQuads     = <span class="keyword">false</span>;</div>
<div class="line">        m_maxFaceSize  = 3;</div>
<div class="line">        m_minFaceSize  = 3;</div>
<div class="line"></div>
<div class="line"> <span class="comment">// need to allocate the arrays first, so we need 2 passes, one to </span></div>
<div class="line"> <span class="comment">// collect stats and determine how large the maps are, and one to </span></div>
<div class="line"> <span class="comment">// fill in the maps</span></div>
<div class="line"> <span class="keywordtype">int</span> poly = 0, subface = 0;</div>
<div class="line"> <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; polyCount; ++i) </div>
<div class="line">        {</div>
<div class="line"> <span class="keywordtype">int</span> edgeCount = 3;</div>
<div class="line"> <span class="keywordflow">while</span> (pMesh-&gt;IsFakeTriangle(i+1))  <span class="comment">// safe as it returns false if i+1 is &gt; polyCount</span></div>
<div class="line">            {  </div>
<div class="line">                ++i; ++edgeCount;</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            ++poly;</div>
<div class="line">            subface  += (edgeCount == 4) ? 1 : edgeCount;</div>
<div class="line"></div>
<div class="line">            ++m_hist[edgeCount];</div>
<div class="line"> <span class="keywordflow">if</span> (m_minFaceSize &gt; edgeCount) m_minFaceSize = edgeCount;</div>
<div class="line"> <span class="keywordflow">if</span> (m_maxFaceSize &lt; edgeCount) m_maxFaceSize = edgeCount;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">        m_iFaceCount                = poly;</div>
<div class="line">        m_iTotalTesselatedFaceCount = polyCount;</div>
<div class="line">        m_iSubFaceCount             = subface;</div>
<div class="line"></div>
<div class="line">        m_FaceMap         = <span class="keyword">new</span> FaceMapEntry[m_iFaceCount];</div>
<div class="line">        m_ReverseFaceMap  = <span class="keyword">new</span> <span class="keywordtype">int</span>[m_iTotalTesselatedFaceCount];</div>
<div class="line"></div>
<div class="line"> <span class="comment">// walk through the triangles looking at the real/fake ones and construct</span></div>
<div class="line"> <span class="comment">// the mappings from poly id to face id and subface id. And back from </span></div>
<div class="line"> <span class="comment">// subface to poly id. </span></div>
<div class="line">        poly = 0, subface = 0;                          </div>
<div class="line"> <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; polyCount; ++i) </div>
<div class="line">        {</div>
<div class="line"> <span class="keyword">const</span> <span class="keywordtype">int</span> ff = i;</div>
<div class="line"></div>
<div class="line">            m_ReverseFaceMap[i]  = poly;</div>
<div class="line"> <span class="keywordtype">int</span> edgeCount = 3;</div>
<div class="line"> <span class="keywordflow">while</span> (pMesh-&gt;IsFakeTriangle(i+1))  <span class="comment">// safe as it returns false if i+1 is &gt; polyCount</span></div>
<div class="line">            {  </div>
<div class="line">                ++i; ++edgeCount;</div>
<div class="line">                m_ReverseFaceMap[i]  = poly;</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            m_FaceMap[poly].m_NumEdges            = edgeCount;</div>
<div class="line">            m_FaceMap[poly].m_MBFaceID            = ff;</div>
<div class="line">            m_FaceMap[poly].m_PTexSubfaceID       = subface;</div>
<div class="line">            m_FaceMap[poly].m_NumTessellatedFaces = edgeCount - 2;</div>
<div class="line"></div>
<div class="line">            ++poly;</div>
<div class="line">            subface  += (edgeCount == 4) ? 1 : edgeCount;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">//------------------------------------------------------------------------------</span></div>
<div class="line"></div>
</div><!-- fragment --> </div><!-- contents -->
</div><!-- doc-content -->
<div class="footer-block"><a class="comments-anchor" href="../html/ac.cmtdialog.htm" target="_blank"><span class="comments-link">Please send us your comment about this page</span></a></div></div>
</div></body>
</html>
