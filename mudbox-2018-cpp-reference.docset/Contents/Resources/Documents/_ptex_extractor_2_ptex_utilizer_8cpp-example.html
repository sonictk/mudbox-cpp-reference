<!-- saved from url=(0024)http://docs.autodesk.com -->
<html>
<head><script src="../scripts/yepnope.1.5.4-min.js" type="text/javascript"></script><script src="../scripts/lib/jquery-1.11.1.min.js" type="text/javascript"></script><meta content="text/html; charset=utf-8" http-equiv="Content-Type"/><meta content="MOBPRO" name="product"/><meta content="2018" name="release"/><meta content="GeneralUser" name="book"/><meta content="2017-09-08" name="created"/><meta content="GUID-02FA7DD3-6C7A-4C6A-B7BC-824765AE1CB2" name="topicid"/><meta content="concept" name="topic-type"/>
<title>PtexExtractor/PtexUtilizer.cpp</title>
</head>
<body height="100%"><div class="body_content" id="body-content"><link href="../style/navtree.css" rel="stylesheet" type="text/css"/><link href="../style/doxygen.css" rel="stylesheet" type="text/css"/><link href="../style/tabs.css" rel="stylesheet" type="text/css"/><link href="../style/adsk.cpm.css" rel="stylesheet" type="text/css"/><script language="javascript">var index = 'index.html';</script><script>$(document).ready(function() { yepnope.injectJs("./scripts/ac_common.js"); });</script><script type="text/javascript">
var tocSystemNeedsToBeLoaded = typeof(cpp_ref_adsk_ref_toc) == 'undefined';
var weAreIn21 = $('div#main.view-active').length;
var tocPrefix = '';
if (weAreIn21)
{ tocPrefix = 'cpp_ref/'; }
function cpp_ref_initializeToc(forceTrigger) {
    cpp_ref_adsk_ref_toc.initResizable();
    cpp_ref_adsk_ref_toc.initNavTree('_ptex_extractor_2_ptex_utilizer_8cpp-example.html', tocPrefix);
    dQuery(document).trigger('toc_initialized');
}
if (tocSystemNeedsToBeLoaded)
{
	yepnope([{
	load:[tocPrefix + 'json3.min.js', tocPrefix + 'jquery.js', tocPrefix + 'ref-toc-controller.js', tocPrefix + 'dynsections.js'],
	complete: function() {
	  if (typeof(dQuery) == 'undefined')
	  {
	    dQuery = jQuery.noConflict(true);
	  }
	  else { jQuery.noConflict(true); }
	  $(document).ready(cpp_ref_initializeToc);
	}
 	}])
}
if (!weAreIn21) { // if in AKN...
$(window).load( function() {
    setTimeout( function() {
        var content = $('body > div').not('#body-content');     // take any divs under body that are not id=body-content
        content.each( function() { 
            $(this).css( { 'padding-left': $(this).css('margin-left') } );       // and if they have any padding-left already, move it to margin-left.
        } );
        var width = cpp_ref_adsk_ref_toc.readFromStorage('width');
        content.css({marginLeft:parseInt(width)+6+"px"});
    }, 100);
} ); 
}
</script><script>$("div#WidgetFloaterPanels,link[href*='microsofttranslator.com'],script[src*='microsofttranslator.com'],script[src*='bing.com']").remove();</script><script type="text/javascript">$("div#navigation,div#breadcrumbs,div#banner").attr("translate","no"); var mtLocation = ((location && location.href && location.href.indexOf('https') == 0)?'https://ssl.microsofttranslator.com':'http://www.microsofttranslator.com')+'/ajax/v3/WidgetV3.ashx?ctf=True&ui=true&settings=Manual&from=en&hidelanguages='; yepnope.injectJs(mtLocation, function() {}, { charset:'utf-8', type:'text/javascript' } );</script><script>
 if (!tocSystemNeedsToBeLoaded) { cpp_ref_initializeToc(); }
 </script><!-- begin MT -->

<div>
<div class="head">
<h1>PtexExtractor/PtexUtilizer.cpp</h1>
</div>
<div id="top"><!-- Generated by Doxygen 1.8.10 -->
<div class="tabs" id="navrow1">
<ul class="tablist">
<li><a href="./index.html"><span>MainÂ Page</span></a></li>
<li><a href="./pages.html"><span>Topics</span></a></li>
<li><a href="./modules.html"><span>Modules</span></a></li>
<li><a href="./namespaces.html"><span>Namespaces</span></a></li>
<li><a href="./annotated.html"><span>Classes</span></a></li>
<li><a href="./files.html"><span>Files</span></a></li>
<li><a href="./examples.html"><span>Examples</span></a></li>
</ul>
</div>
</div><!-- top -->
<div class="ui-resizable side-nav-resizable" id="side-nav">
<div id="nav-tree">
<div id="nav-tree-contents">
<div class="sync" id="nav-sync"></div>
</div>
</div>
<div class="ui-resizable-handle" id="splitbar" style="-moz-user-select:none;">
</div>
</div>
<div id="doc-content">
<div class="header">
<div class="headertitle">
<div class="title">PtexExtractor/PtexUtilizer.cpp</div> </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"></div>
<div class="line"><span class="comment">//**************************************************************************/</span></div>
<div class="line"><span class="comment">// Copyright (c) 2010 Autodesk, Inc.</span></div>
<div class="line"><span class="comment">// All rights reserved.</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">// Use of this software is subject to the terms of the Autodesk license</span></div>
<div class="line"><span class="comment">// agreement provided at the time of installation or download, or which</span></div>
<div class="line"><span class="comment">// otherwise accompanies this software in either electronic or hard copy form.</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">//**************************************************************************/</span></div>
<div class="line"><span class="comment">// DESCRIPTION:</span></div>
<div class="line"><span class="comment">// CREATED: August 2010</span></div>
<div class="line"><span class="comment">//**************************************************************************/</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include "PtexUtilizer.h"</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;omp.h&gt;</span></div>
<div class="line"></div>
<div class="line">Preferences::String g_sPtexPath(</div>
<div class="line"> <a name="a0"></a><a class="code" href="./i18n_8h.html#aa4e0fec95bdcbdcbe9b3140339e17771">NTR</a>(<span class="stringliteral">"Map Extraction Ptex Folder"</span>),</div>
<div class="line"> <a class="code" href="./i18n_8h.html#aa4e0fec95bdcbdcbe9b3140339e17771">NTR</a>(<span class="stringliteral">"Paths"</span>), </div>
<div class="line">    QObject::tr(<span class="stringliteral">"Map Extraction Ptex Folder"</span>),</div>
<div class="line">    QObject::tr(<span class="stringliteral">"Paths"</span>), </div>
<div class="line"> <a name="a1"></a><a class="code" href="./namespacemudbox.html#ae9df9ee935ec6744f98a1585d9db01df">Kernel</a>()-&gt;Preferences()-&gt;m_sTexturePath.Value(),</div>
<div class="line">    false );</div>
<div class="line"></div>
<div class="line"><span class="comment">// RTTI macro, needed for each class.</span></div>
<div class="line"><a name="a2"></a><a class="code" href="./node_8h.html#ad54524b181b971ce9b577312ba2c5e65">IMPLEMENT_SCLASS</a>( PtexUtilizer, Utilizer, <span class="stringliteral">"ptexutilizer"</span>, 2 );</div>
<div class="line"></div>
<div class="line">PtexUtilizer::PtexUtilizer( <span class="keywordtype">void</span> ) : </div>
<div class="line">    m_pWriter( NULL ), </div>
<div class="line">    m_iChannelCount( 3 ), </div>
<div class="line">    m_bIncludeMeshData( this, <span class="stringliteral">"includemeshdata"</span> ), </div>
<div class="line">    m_eFormat( this, <span class="stringliteral">"format"</span> ), </div>
<div class="line">    m_iPtexFaceCount( 0 ), </div>
<div class="line">    m_sFileName( this, <a name="a3"></a><a class="code" href="./i18n_8h.html#a1b7f65502ea5b58cca15f85d9e78ca06">NTRQ</a>(<span class="stringliteral">"filename"</span>), false ),</div>
<div class="line">    m_sFilePath( this, <span class="stringliteral">"filepath"</span> )</div>
<div class="line">{</div>
<div class="line">    m_bIncludeMeshData.SetName( QObject::tr( <span class="stringliteral">"Include Mesh Data:"</span> ) );</div>
<div class="line">    m_bIncludeMeshData.SetToolTip( QObject::tr( <span class="stringliteral">"Store the mesh data with the ptex file.  This is useful if you are using a ptex viewer program to preview the ptex file."</span> ) );</div>
<div class="line">    m_bIncludeMeshData = <span class="keyword">true</span>;</div>
<div class="line">    m_eFormat.SetName( QObject::tr( <span class="stringliteral">"Data Format:"</span> ) );</div>
<div class="line">    m_eFormat.SetToolTip( QObject::tr( <span class="stringliteral">"Format of the data in the file. This affects precision and file size."</span> ) );</div>
<div class="line">    m_eFormat.AddItem( QObject::tr( <span class="stringliteral">"8 bit integer"</span> ) );</div>
<div class="line">    m_eFormat.AddItem( QObject::tr( <span class="stringliteral">"16 bit integer"</span> ) );</div>
<div class="line">    m_eFormat.AddItem( QObject::tr( <span class="stringliteral">"16 bit float"</span> ) );</div>
<div class="line">    m_eFormat.AddItem( QObject::tr( <span class="stringliteral">"32 bit float"</span> ) );</div>
<div class="line">    m_eFormat = 3;</div>
<div class="line">    m_sFileName.m_sFilter = QObject::tr( <span class="stringliteral">"Ptex files (*.ptx)"</span> );</div>
<div class="line">    m_sFileName.SetInstantEdit( <span class="keyword">true</span> );</div>
<div class="line">    m_sFileName.SetName( QObject::tr( <span class="stringliteral">"File Name:"</span> ) );</div>
<div class="line">    m_sFilePath.Connect( *g_sPtexPath.m_pAttribute );</div>
<div class="line">    m_sFilePath.SetVisible( <span class="keyword">false</span> );</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> PtexUtilizer::OnNodeEvent( <span class="keyword">const</span> Attribute &amp;<a class="code" href="./_g_lee_8h.html#ac8729153468b5dcf13f971b21d84d4e5">a</a>, <a name="a4"></a><a class="code" href="./namespacemudbox.html#a8d88d2a841f889dace76ffcd8d6b06da">NodeEventType</a> <a class="code" href="./_g_lee_8h.html#a653819996e713edf9c01a5b564199189">t</a> )</div>
<div class="line">{</div>
<div class="line"> <span class="keywordflow">if</span> ( a == m_sFilePath &amp;&amp; t == <a name="a5"></a><a class="code" href="./namespacemudbox.html#a8d88d2a841f889dace76ffcd8d6b06daa274758890f9a27906be7336f4b8e4780">etValueChanged</a> )</div>
<div class="line">        m_sFileName.m_sPath = m_sFilePath;</div>
<div class="line"> <span class="keywordflow">if</span> ( a == m_sFileName &amp;&amp; t == <a class="code" href="./namespacemudbox.html#a8d88d2a841f889dace76ffcd8d6b06daa274758890f9a27906be7336f4b8e4780">etValueChanged</a> )</div>
<div class="line">        Extractor()-&gt;ValidityChanged();</div>
<div class="line"> <span class="keywordflow">if</span> ( a == m_sFileName &amp;&amp; t == <a name="a6"></a><a class="code" href="./namespacemudbox.html#a8d88d2a841f889dace76ffcd8d6b06daa86d011cabee6ad46ce064e16c2734173">etEditingFinished</a> )</div>
<div class="line">        g_sPtexPath.m_pAttribute-&gt;SetValue( m_sFileName.m_sPath );</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#define WRITEFACE( type, multiplier ) \</span></div>
<div class="line"><span class="preprocessor">{ \</span></div>
<div class="line"><span class="preprocessor">    type *p = new type[d.m_aData.size()]; \</span></div>
<div class="line"><span class="preprocessor">    for ( int i = 0; i &lt; d.m_aData.size() &amp;&amp; p; i++ ) \</span></div>
<div class="line"><span class="preprocessor">        p[i] = (type)(multiplier*d.m_aData[i]); \</span></div>
<div class="line"><span class="preprocessor">    m_pWriter-&gt;writeFace( iFaceID, sInfo, p ); \</span></div>
<div class="line"><span class="preprocessor">    delete [] p; \</span></div>
<div class="line"><span class="preprocessor">};</span></div>
<div class="line"></div>
<div class="line"><span class="comment">// Main function. This is called once for each reference point with the corresponding data. The function must store the data, and later write it to the ptex file.</span></div>
<div class="line"><span class="comment">// This function must be thread safe, so we cannot use a single FaceData, because the data might arrive in a changed order.</span></div>
<div class="line"><span class="keywordtype">void</span> PtexUtilizer::StoreData( <span class="keyword">const</span> Data &amp;cData, <span class="keyword">const</span> TargetLocation &amp;cTarget, <span class="keyword">const</span> SurfacePoint &amp; )</div>
<div class="line">{</div>
<div class="line"> <span class="comment">// First we obtain some important data from the reference point. These were added to the structure by the PtexLayout class. See PtexLayout::ProcessSurface.</span></div>
<div class="line"> <span class="keywordtype">int</span> u = cTarget.m_aLayoutData[PtexLayout::dataURes]&amp;0xffffff, <a class="code" href="./_g_lee_8h.html#a14cfbe2fc2234f5504618905b69d1e06">v</a> = cTarget.m_aLayoutData[PtexLayout::dataVRes]&amp;0xffffff;</div>
<div class="line"> <span class="keywordtype">int</span> ures = cTarget.m_aLayoutData[PtexLayout::dataURes]&gt;&gt;24, vres = cTarget.m_aLayoutData[PtexLayout::dataVRes]&gt;&gt;24;</div>
<div class="line"> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> iFaceID = cTarget.m_aLayoutData[PtexLayout::dataFaceID];</div>
<div class="line"> <span class="keywordtype">bool</span> bSubface = iFaceID &amp; 0x80000000;</div>
<div class="line">    iFaceID &amp;= 0x7fffffff;</div>
<div class="line"> <span class="keywordtype">int</span> <a class="code" href="./_g_lee_8h.html#a775b535bae9cb9131338b1cda0807472">w</a> = 1 &lt;&lt; ures, <a class="code" href="./_g_lee_8h.html#afdb89eb8f3f04e3f311b84bafe6f7d0d">h</a> = 1 &lt;&lt; vres;</div>
<div class="line"></div>
<div class="line"> <span class="comment">// If the m_aFaces array is empty, we initialize it with NULL pointers for each face. NULL pointer means that the processing of that face is not yet begun,</span></div>
<div class="line"> <span class="comment">// or it is already finished, so we don't store any data for that face in the memory.</span></div>
<div class="line"> <span class="keywordflow">if</span> ( m_aFaces.size() == 0 )</div>
<div class="line">    {</div>
<div class="line"><span class="preprocessor">#pragma omp critical (initfaces)</span></div>
<div class="line">        {</div>
<div class="line"> <span class="keywordflow">if</span> ( m_aFaces.size() == 0 )</div>
<div class="line">            {</div>
<div class="line"> <span class="comment">// Calculate the number of ptex faces needed for the mesh.</span></div>
<div class="line"> <span class="keyword">const</span> Mesh *pMesh = cTarget.Mesh();</div>
<div class="line"> <span class="keywordflow">if</span> ( pMesh-&gt;Type() == Mesh::typeQuadric )</div>
<div class="line">                    m_iPtexFaceCount = pMesh-&gt;FaceCount();</div>
<div class="line"> <span class="keywordflow">else</span></div>
<div class="line">                {</div>
<div class="line"> <span class="comment">// For each polygon, first calculate the number of sides.</span></div>
<div class="line">                    m_iPtexFaceCount = 0;</div>
<div class="line"> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0;</div>
<div class="line"> <span class="keywordflow">while</span> ( i &lt; pMesh-&gt;FaceCount() )</div>
<div class="line">                    {</div>
<div class="line"> <span class="keywordtype">int</span> <a class="code" href="./_g_lee_8h.html#ad585a1393cfa368fa9dc3d8ebff640d5">s</a> = 3;</div>
<div class="line">                        i++;</div>
<div class="line"> <span class="keywordflow">while</span> ( i &lt; pMesh-&gt;FaceCount() &amp;&amp; pMesh-&gt;IsFakeTriangle( i ) )</div>
<div class="line">                        {</div>
<div class="line">                            i++; s++;</div>
<div class="line">                        };</div>
<div class="line"></div>
<div class="line"> <span class="comment">// If it is a quad (i.e. has 4 sides) then it will be represented with a single ptex face, otherwise each vertex</span></div>
<div class="line"> <span class="comment">// will have its own ptex face.</span></div>
<div class="line"> <span class="keywordflow">if</span> ( s == 4 )</div>
<div class="line">                            m_iPtexFaceCount++;</div>
<div class="line"> <span class="keywordflow">else</span></div>
<div class="line">                            m_iPtexFaceCount += <a name="a7"></a><a class="code" href="./_g_lee_8h.html#ad585a1393cfa368fa9dc3d8ebff640d5">s</a>;</div>
<div class="line">                    };</div>
<div class="line">                };</div>
<div class="line"> </div>
<div class="line">                m_iFacesProcessed = 0;</div>
<div class="line">                m_aFaces.fill( NULL, m_iPtexFaceCount );</div>
<div class="line">            };</div>
<div class="line">        };</div>
<div class="line">    };</div>
<div class="line"> </div>
<div class="line"> <span class="comment">// If the given face has no data yet, then we allocate a structure.</span></div>
<div class="line"> <span class="keywordflow">if</span> ( !m_aFaces[iFaceID] )</div>
<div class="line">    {</div>
<div class="line"><span class="preprocessor">#pragma omp critical (insertface)</span></div>
<div class="line">        {</div>
<div class="line"> <span class="keywordflow">if</span> ( !m_aFaces[iFaceID] )</div>
<div class="line">                m_aFaces[iFaceID] = <span class="keyword">new</span> FaceData( w, h, m_iChannelCount );</div>
<div class="line">        };</div>
<div class="line">    };</div>
<div class="line"></div>
<div class="line"> <span class="comment">// We simply store the data in the structure which belongs to the face.</span></div>
<div class="line">    FaceData &amp;d = *m_aFaces[iFaceID];</div>
<div class="line"> <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> <a class="code" href="./_g_lee_8h.html#a1f2d7f8147412c43ba2303a56f97ee73">c</a> = 0; <a class="code" href="./_g_lee_8h.html#a1f2d7f8147412c43ba2303a56f97ee73">c</a> &lt; m_iChannelCount; <a class="code" href="./_g_lee_8h.html#a1f2d7f8147412c43ba2303a56f97ee73">c</a>++ )</div>
<div class="line">        d.m_aData[<a class="code" href="./_g_lee_8h.html#a1f2d7f8147412c43ba2303a56f97ee73">c</a>+(u+<a class="code" href="./_g_lee_8h.html#a14cfbe2fc2234f5504618905b69d1e06">v</a>*w)*m_iChannelCount] = ((<span class="keyword">const</span> <span class="keywordtype">float</span> *)(cData.As_Color()))[<a name="a8"></a><a class="code" href="./_g_lee_8h.html#a1f2d7f8147412c43ba2303a56f97ee73">c</a>];</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#pragma omp atomic</span></div>
<div class="line">    d.m_iSamplesLeft--;</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Chech the number of stored reference points for the face. If we exceed the total number of reference points, we can write the data related to the face to the ptex file</span></div>
<div class="line"> <span class="comment">// and delete the memory used.</span></div>
<div class="line"> <span class="keywordflow">if</span> ( d.m_iSamplesLeft == 0 )</div>
<div class="line">    {</div>
<div class="line"><span class="preprocessor">#pragma omp critical (flushface)</span></div>
<div class="line">        {</div>
<div class="line"> <span class="keywordflow">if</span> ( d.m_iSamplesLeft == 0 )</div>
<div class="line">            {</div>
<div class="line"> <span class="comment">// If no writer object is created yet, then we create one for this mesh.</span></div>
<div class="line"> <span class="keywordflow">if</span> ( !m_pWriter )</div>
<div class="line">                    OpenFile( cTarget.Mesh() );</div>
<div class="line"></div>
<div class="line"> <a name="a9"></a><a class="code" href="./mudbox_8h.html#a24f4fe4a32c8501c3cae26db72954a30">MB_ASSERT</a>( m_pMesh == cTarget.Mesh() );</div>
<div class="line"> </div>
<div class="line"> <span class="comment">// Create and fill a structure for the face.</span></div>
<div class="line">                Ptex::FaceInfo sInfo;</div>
<div class="line"> <span class="keywordflow">if</span> ( bSubface )</div>
<div class="line">                    sInfo.flags |= Ptex::FaceInfo::flag_subface;</div>
<div class="line">                sInfo.res = Ptex::Res( ures, vres );</div>
<div class="line"></div>
<div class="line"> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> af[4], ae[4];</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Store the adjacency information for the face. This is used by the ptex library to do filtering at face edges.</span></div>
<div class="line"> <span class="keywordflow">if</span> ( m_pMesh-&gt;Type() == Mesh::typeQuadric )</div>
<div class="line">                {</div>
<div class="line"> <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> <a class="code" href="./_g_lee_8h.html#a1f2d7f8147412c43ba2303a56f97ee73">c</a> = 0; <a class="code" href="./_g_lee_8h.html#a1f2d7f8147412c43ba2303a56f97ee73">c</a> &lt; 4; <a class="code" href="./_g_lee_8h.html#a1f2d7f8147412c43ba2303a56f97ee73">c</a>++ )</div>
<div class="line">                    {</div>
<div class="line"> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> a = cTarget.m_pMesh-&gt;QuadAdjacency( cTarget.m_iFaceIndex, <a class="code" href="./_g_lee_8h.html#a1f2d7f8147412c43ba2303a56f97ee73">c</a> );</div>
<div class="line"> <span class="comment">// When the returned value is 0xffffffff it means there is no adjacent face in that direction, so it is an open edge.</span></div>
<div class="line"> <span class="keywordflow">if</span> ( a == 0xffffffff )</div>
<div class="line">                        {</div>
<div class="line"> <span class="comment">// When there is no adjacent face, the adjacent face index must be set to -1 (edge index is ignored)</span></div>
<div class="line">                            af[<a class="code" href="./_g_lee_8h.html#a1f2d7f8147412c43ba2303a56f97ee73">c</a>] = 0xffffffff;</div>
<div class="line">                            ae[<a class="code" href="./_g_lee_8h.html#a1f2d7f8147412c43ba2303a56f97ee73">c</a>] = 0;</div>
<div class="line">                        }</div>
<div class="line"> <span class="keywordflow">else</span></div>
<div class="line">                        {</div>
<div class="line">                            af[<a class="code" href="./_g_lee_8h.html#a1f2d7f8147412c43ba2303a56f97ee73">c</a>] = a/4;</div>
<div class="line">                            ae[<a class="code" href="./_g_lee_8h.html#a1f2d7f8147412c43ba2303a56f97ee73">c</a>] = a%4;</div>
<div class="line">                        };</div>
<div class="line">                    };</div>
<div class="line">                }</div>
<div class="line"> <span class="keywordflow">else</span></div>
<div class="line">                {</div>
<div class="line"> <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="./_g_lee_8h.html#a1f2d7f8147412c43ba2303a56f97ee73">c</a> = 0; <a class="code" href="./_g_lee_8h.html#a1f2d7f8147412c43ba2303a56f97ee73">c</a> &lt; 4; <a class="code" href="./_g_lee_8h.html#a1f2d7f8147412c43ba2303a56f97ee73">c</a>++ )</div>
<div class="line">                        af[<a class="code" href="./_g_lee_8h.html#a1f2d7f8147412c43ba2303a56f97ee73">c</a>] = m_pLayout-&gt;AdjacentFace( iFaceID, <a class="code" href="./_g_lee_8h.html#a1f2d7f8147412c43ba2303a56f97ee73">c</a>, ae[<a class="code" href="./_g_lee_8h.html#a1f2d7f8147412c43ba2303a56f97ee73">c</a>] );</div>
<div class="line">                };</div>
<div class="line">                sInfo.setadjfaces( af[0], af[1], af[2], af[3] );</div>
<div class="line">                sInfo.setadjedges( ae[0], ae[1], ae[2], ae[3] );</div>
<div class="line"> </div>
<div class="line"> <span class="comment">// When all the data is ready, we pass the FaceInfo structure along with the data collected to the ptex library.</span></div>
<div class="line"> <span class="keywordflow">switch</span> ( m_eFormat )</div>
<div class="line">                {</div>
<div class="line"> <span class="keywordflow">case</span> eFormat8bitInteger:</div>
<div class="line">                        WRITEFACE( <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>, 255 );</div>
<div class="line"> <span class="keywordflow">break</span>;</div>
<div class="line"> <span class="keywordflow">case</span> eFormat16bitInteger:</div>
<div class="line">                        WRITEFACE( <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>, 65536 );</div>
<div class="line"> <span class="keywordflow">break</span>;</div>
<div class="line"> <span class="keywordflow">case</span> eFormat16bitFloat:</div>
<div class="line">                        WRITEFACE( half_, 1 );</div>
<div class="line"> <span class="keywordflow">break</span>;</div>
<div class="line"> <span class="keywordflow">case</span> eFormat32bitFloat:</div>
<div class="line">                        WRITEFACE( <span class="keywordtype">float</span>, 1 );</div>
<div class="line">                };</div>
<div class="line"> </div>
<div class="line"> <span class="comment">// Since the face won't get any further data, we can remove the related structure from the memory.</span></div>
<div class="line"> <span class="keyword">delete</span> m_aFaces[iFaceID];</div>
<div class="line">                m_aFaces[iFaceID] = NULL;</div>
<div class="line">                m_iFacesProcessed++;</div>
<div class="line">            };</div>
<div class="line">        };</div>
<div class="line">    };</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="comment">// This function is called by the map extraction framework when an event occurs related to the reference points.</span></div>
<div class="line"><span class="keywordtype">void</span> PtexUtilizer::OnPhaseEvent( <a name="a10"></a><a class="code" href="./namespacemapextractionmodules.html#a0d06a52f518448d061f6d90f5a0eae60">PhaseEventType</a> t )</div>
<div class="line">{</div>
<div class="line"> <span class="comment">// The only one event what we are interested in is the end of a section. When that happens, we close the current ptex </span></div>
<div class="line"> <span class="comment">// file since all the faces are processed for the current mesh.</span></div>
<div class="line"> <span class="keywordflow">if</span> ( t == <a name="a11"></a><a class="code" href="./namespacemapextractionmodules.html#a0d06a52f518448d061f6d90f5a0eae60a8f91cc7e2d07e031b0ae001cdb0a4aca">eventSectionEnd</a> )</div>
<div class="line">    {</div>
<div class="line"> <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; m_iPtexFaceCount; i++ )</div>
<div class="line"> <a class="code" href="./mudbox_8h.html#a24f4fe4a32c8501c3cae26db72954a30">MB_ASSERT</a>( m_aFaces[i] == 0 );</div>
<div class="line">        m_aFaces.clear();</div>
<div class="line"> <span class="keywordflow">if</span> ( m_pWriter )</div>
<div class="line">            CloseFile();</div>
<div class="line">    };</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="comment">// Create a new PtexWriter object for the given mesh, which will be used to write data to the ptex file.</span></div>
<div class="line"><span class="keywordtype">void</span> PtexUtilizer::OpenFile( <span class="keyword">const</span> Mesh *pMesh )</div>
<div class="line">{</div>
<div class="line"> <a class="code" href="./mudbox_8h.html#a24f4fe4a32c8501c3cae26db72954a30">MB_ASSERT</a>( !m_pWriter );</div>
<div class="line"> <span class="comment">// Since each mesh uses its own section of reference points, different meshes will never be mixed. So we can safely use a single pointer</span></div>
<div class="line"> <span class="comment">// for the current mesh.</span></div>
<div class="line">    m_pMesh = pMesh;</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Create and open the ptex file using the ptex library.</span></div>
<div class="line">    Ptex::String sError;</div>
<div class="line"> <a name="_a12"></a><a class="code" href="./class_q_string.html">QString</a> sFileName = m_sFileName;</div>
<div class="line"> </div>
<div class="line"> <span class="comment">// replace %s with the name of the current target</span></div>
<div class="line">    MapExtractor *pM = Extractor();</div>
<div class="line"> <span class="keywordflow">if</span> ( pM &amp;&amp; pM-&gt;TargetMesh(pM-&gt;CurrentTarget()) &amp;&amp; pM-&gt;TargetMesh(pM-&gt;CurrentTarget())-&gt;Geometry() )</div>
<div class="line">    {</div>
<div class="line"> <a class="code" href="./class_q_string.html">QString</a> sTargetID = pM-&gt;TargetMesh( pM-&gt;CurrentTarget() )-&gt;Geometry()-&gt;Name();</div>
<div class="line"> <span class="keywordflow">if</span> (!sTargetID.<a name="a13"></a><a class="code" href="./class_q_string.html#a479432127ee77145cc19d6a2d1590821">isEmpty</a>())</div>
<div class="line">            sFileName.<a name="a14"></a><a class="code" href="./class_q_string.html#a66d144907b2223efc0026a0241ded8d0">replace</a>( <span class="stringliteral">"%s"</span>, sTargetID );</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"> <span class="keywordflow">if</span> (!<a name="a15"></a><a class="code" href="./class_q_dir.html#a470d5aee0333ba5ebb1417597867fb9c">QDir::isAbsolutePath</a>(sFileName) )</div>
<div class="line">        sFileName = <a name="_a16"></a><a class="code" href="./class_q_dir.html">QDir</a>(<a class="code" href="./namespacemudbox.html#ae9df9ee935ec6744f98a1585d9db01df">Kernel</a>()-&gt;Preferences()-&gt;m_sDataPath.Value()).absoluteFilePath(sFileName);</div>
<div class="line"> <a name="_a17"></a><a class="code" href="./class_q_byte_array.html">QByteArray</a> qbaFileMask = <a name="a18"></a><a class="code" href="./class_q_file.html#a548ef3f34e5265ca50980914ccabbfde">QFile::encodeName</a>(sFileName);</div>
<div class="line">    Ptex::DataType aFormats[4] = { Ptex::dt_uint8, Ptex::dt_uint16, Ptex::dt_half, Ptex::dt_float };</div>
<div class="line">    PtexWriter::setTempFolder( <a class="code" href="./namespacemudbox.html#ae9df9ee935ec6744f98a1585d9db01df">Kernel</a>()-&gt;Preferences()-&gt;m_sTempPath.Value().toStdString() );</div>
<div class="line">    m_pWriter = PtexWriter::open( qbaFileMask.<a name="a19"></a><a class="code" href="./class_q_byte_array.html#acd2173722996016205933aa3053f895f">constData</a>(), Ptex::mt_quad, aFormats[m_eFormat], m_iChannelCount, -1, m_iPtexFaceCount, sError );</div>
<div class="line"> <span class="keywordflow">if</span> ( !m_pWriter )</div>
<div class="line"> <a name="a20"></a><a class="code" href="./mudbox_8h.html#a78d8bd615152a82160d33c6063f0e308">MB_ERROR</a>( sError.c_str() );</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="comment">// This function writes the topology data to the ptex file (if needed) and closes the file.</span></div>
<div class="line"><span class="keywordtype">void</span> PtexUtilizer::CloseFile( <span class="keywordtype">void</span> )</div>
<div class="line">{</div>
<div class="line"> <a name="a21"></a><a class="code" href="./mudbox_8h.html#a4574db3fa92e5236e049b3e67bc51cd9">MB_ONBUG</a>( !m_pWriter )</div>
<div class="line">        return;</div>
<div class="line"></div>
<div class="line"> <span class="comment">// We only write topology data to the file if the m_bIncludeData attribute is set to true. It is recommended to write the topology data to the file since some</span></div>
<div class="line"> <span class="comment">// tools can use the data when processing the file, but it is optional. The default is on.</span></div>
<div class="line">    if ( m_bIncludeMeshData )</div>
<div class="line">        WriteMeshData( m_pWriter, m_pMesh );</div>
<div class="line"> </div>
<div class="line"> <span class="comment">// Close the file, and release the object.</span></div>
<div class="line">    Ptex::String sError;</div>
<div class="line"> <span class="keywordtype">bool</span> bOk = m_pWriter-&gt;close( sError );</div>
<div class="line">    m_pWriter-&gt;release();</div>
<div class="line">    m_pWriter = NULL;</div>
<div class="line">    if ( !bOk )</div>
<div class="line"> <a class="code" href="./mudbox_8h.html#a78d8bd615152a82160d33c6063f0e308">MB_ERROR</a>( sError.c_str() );</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> PtexUtilizer::WriteMeshData( PtexWriter *pWriter, const Mesh *pMesh )</div>
<div class="line">{</div>
<div class="line"> <span class="comment">// First write the position of the vertices into the file as metadata.</span></div>
<div class="line"> <a name="_a22"></a><a class="code" href="./class_q_vector.html">QVector&lt;float&gt;</a> aVertexPositions( pMesh-&gt;VertexCount()*3 );</div>
<div class="line"> <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="./_g_lee_8h.html#a1f2d7f8147412c43ba2303a56f97ee73">c</a> = 0; <a class="code" href="./_g_lee_8h.html#a1f2d7f8147412c43ba2303a56f97ee73">c</a> &lt; pMesh-&gt;VertexCount(); <a class="code" href="./_g_lee_8h.html#a1f2d7f8147412c43ba2303a56f97ee73">c</a>++ )</div>
<div class="line">    {</div>
<div class="line">        Vector <a class="code" href="./_g_lee_8h.html#a14cfbe2fc2234f5504618905b69d1e06">v</a> = pMesh-&gt;Geometry()-&gt;Transformation()-&gt;TransformToWorld( pMesh-&gt;VertexPosition( <a class="code" href="./_g_lee_8h.html#a1f2d7f8147412c43ba2303a56f97ee73">c</a> ) );</div>
<div class="line">        aVertexPositions[<a class="code" href="./_g_lee_8h.html#a1f2d7f8147412c43ba2303a56f97ee73">c</a>*3+0] = v.x;</div>
<div class="line">        aVertexPositions[<a class="code" href="./_g_lee_8h.html#a1f2d7f8147412c43ba2303a56f97ee73">c</a>*3+1] = v.y;</div>
<div class="line">        aVertexPositions[<a class="code" href="./_g_lee_8h.html#a1f2d7f8147412c43ba2303a56f97ee73">c</a>*3+2] = v.z;</div>
<div class="line">    };</div>
<div class="line">    pWriter-&gt;writeMeta( <span class="stringliteral">"PtexVertPositions"</span>, aVertexPositions.data(), aVertexPositions.size() );</div>
<div class="line"></div>
<div class="line"> <a name="_a23"></a><a class="code" href="./class_q_vector.html">QVector&lt;int&gt;</a> aFaceVertexIndices;</div>
<div class="line"> <a class="code" href="./class_q_vector.html">QVector&lt;int&gt;</a> aFaceVertexCounts;</div>
<div class="line"> <span class="keywordflow">if</span> ( pMesh-&gt;Type() == Mesh::typeQuadric )</div>
<div class="line">    {</div>
<div class="line"> <span class="comment">// Write the vertex indices for the faces.</span></div>
<div class="line">        aFaceVertexIndices.<a name="a24"></a><a class="code" href="./class_q_vector.html#ada388d17b93c54a1a0f6edddbe0953ab">resize</a>( pMesh-&gt;FaceCount()*4 );</div>
<div class="line"> <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="./_g_lee_8h.html#a691492ec0bd6383f91200e49f6ae40ed">f</a> = 0; <a class="code" href="./_g_lee_8h.html#a691492ec0bd6383f91200e49f6ae40ed">f</a> &lt; pMesh-&gt;FaceCount(); <a class="code" href="./_g_lee_8h.html#a691492ec0bd6383f91200e49f6ae40ed">f</a>++ )</div>
<div class="line"> <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> <a class="code" href="./_g_lee_8h.html#a1f2d7f8147412c43ba2303a56f97ee73">c</a> = 0; <a class="code" href="./_g_lee_8h.html#a1f2d7f8147412c43ba2303a56f97ee73">c</a> &lt; 4; <a class="code" href="./_g_lee_8h.html#a1f2d7f8147412c43ba2303a56f97ee73">c</a>++ )</div>
<div class="line">                aFaceVertexIndices[<a class="code" href="./_g_lee_8h.html#a691492ec0bd6383f91200e49f6ae40ed">f</a>*4+<a class="code" href="./_g_lee_8h.html#a1f2d7f8147412c43ba2303a56f97ee73">c</a>] = pMesh-&gt;QuadIndex( <a class="code" href="./_g_lee_8h.html#a691492ec0bd6383f91200e49f6ae40ed">f</a>, <a class="code" href="./_g_lee_8h.html#a1f2d7f8147412c43ba2303a56f97ee73">c</a> );</div>
<div class="line"> </div>
<div class="line"> <span class="comment">// Write the number of vertices for the faces into the file. Since we are only processing quad meshes, this array is full of 4.</span></div>
<div class="line">        aFaceVertexCounts.<a name="a25"></a><a class="code" href="./class_q_vector.html#a85a9badce4a1326d50303ebeefde0fb0">fill</a>( 4, pMesh-&gt;FaceCount() );</div>
<div class="line">    }</div>
<div class="line"> <span class="keywordflow">else</span></div>
<div class="line">    {</div>
<div class="line"> <span class="comment">// Count the number of polygons.</span></div>
<div class="line"> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> iPolygonCount = 0;</div>
<div class="line"> <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="./_g_lee_8h.html#a691492ec0bd6383f91200e49f6ae40ed">f</a> = 0; <a class="code" href="./_g_lee_8h.html#a691492ec0bd6383f91200e49f6ae40ed">f</a> &lt; pMesh-&gt;FaceCount(); <a class="code" href="./_g_lee_8h.html#a691492ec0bd6383f91200e49f6ae40ed">f</a>++ )</div>
<div class="line"> <span class="keywordflow">if</span> ( !pMesh-&gt;IsFakeTriangle( <a class="code" href="./_g_lee_8h.html#a691492ec0bd6383f91200e49f6ae40ed">f</a> ) )</div>
<div class="line">                iPolygonCount++;</div>
<div class="line">        aFaceVertexIndices.<a class="code" href="./class_q_vector.html#ada388d17b93c54a1a0f6edddbe0953ab">resize</a>( pMesh-&gt;FaceCount()+2*(iPolygonCount) );</div>
<div class="line">        aFaceVertexCounts.<a class="code" href="./class_q_vector.html#ada388d17b93c54a1a0f6edddbe0953ab">resize</a>( iPolygonCount );</div>
<div class="line"></div>
<div class="line"> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> iVertexIndex = 0, iPolygonIndex = 0;</div>
<div class="line"> <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="./_g_lee_8h.html#a691492ec0bd6383f91200e49f6ae40ed">f</a> = 0, <a class="code" href="./_g_lee_8h.html#aa5367c14d90f462230c2611b81b41d23">p</a> = 0; <a class="code" href="./_g_lee_8h.html#a691492ec0bd6383f91200e49f6ae40ed">f</a> &lt; pMesh-&gt;FaceCount(); <a class="code" href="./_g_lee_8h.html#a691492ec0bd6383f91200e49f6ae40ed">f</a>++ )</div>
<div class="line">        {</div>
<div class="line"> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> iSideCount = 3;</div>
<div class="line">            aFaceVertexIndices[iVertexIndex++] = pMesh-&gt;TriangleIndex( <a class="code" href="./_g_lee_8h.html#a691492ec0bd6383f91200e49f6ae40ed">f</a>, 0 );</div>
<div class="line">            aFaceVertexIndices[iVertexIndex++] = pMesh-&gt;TriangleIndex( <a class="code" href="./_g_lee_8h.html#a691492ec0bd6383f91200e49f6ae40ed">f</a>, 1 );</div>
<div class="line">            aFaceVertexIndices[iVertexIndex++] = pMesh-&gt;TriangleIndex( <a class="code" href="./_g_lee_8h.html#a691492ec0bd6383f91200e49f6ae40ed">f</a>, 2 );</div>
<div class="line"> <span class="keywordflow">while</span> ( <a class="code" href="./_g_lee_8h.html#a691492ec0bd6383f91200e49f6ae40ed">f &lt; pMesh-&gt;</a>FaceCount()-1 &amp;&amp; pMesh-&gt;IsFakeTriangle( <a class="code" href="./_g_lee_8h.html#a691492ec0bd6383f91200e49f6ae40ed">f</a>+1 ) )</div>
<div class="line">            {</div>
<div class="line"> <a class="code" href="./_g_lee_8h.html#a691492ec0bd6383f91200e49f6ae40ed">f</a>++;</div>
<div class="line">                iSideCount++;</div>
<div class="line">                aFaceVertexIndices[iVertexIndex++] = pMesh-&gt;TriangleIndex( <a class="code" href="./_g_lee_8h.html#a691492ec0bd6383f91200e49f6ae40ed">f</a>, 2 );</div>
<div class="line">            };</div>
<div class="line">            aFaceVertexCounts[iPolygonIndex++] = iSideCount;</div>
<div class="line">        };</div>
<div class="line"> <a class="code" href="./mudbox_8h.html#a24f4fe4a32c8501c3cae26db72954a30">MB_ASSERT</a>( (<span class="keywordtype">int</span>)iVertexIndex == aFaceVertexIndices.<a name="a26"></a><a class="code" href="./class_q_vector.html#ab8e4e3e2a7bf18888b71bdf9dda0770b">size</a>() );</div>
<div class="line"> <a class="code" href="./mudbox_8h.html#a24f4fe4a32c8501c3cae26db72954a30">MB_ASSERT</a>( (<span class="keywordtype">int</span>)iPolygonIndex == aFaceVertexCounts.<a class="code" href="./class_q_vector.html#ab8e4e3e2a7bf18888b71bdf9dda0770b">size</a>() );</div>
<div class="line">    };</div>
<div class="line">    pWriter-&gt;writeMeta( <span class="stringliteral">"PtexFaceVertIndices"</span>, aFaceVertexIndices.<a name="a27"></a><a class="code" href="./class_q_vector.html#a1699472936b80a88d3fc8096975d21b2">data</a>(), aFaceVertexIndices.<a class="code" href="./class_q_vector.html#ab8e4e3e2a7bf18888b71bdf9dda0770b">size</a>() );</div>
<div class="line">    pWriter-&gt;writeMeta( <span class="stringliteral">"PtexFaceVertCounts"</span>, aFaceVertexCounts.<a class="code" href="./class_q_vector.html#a1699472936b80a88d3fc8096975d21b2">data</a>(), aFaceVertexCounts.<a class="code" href="./class_q_vector.html#ab8e4e3e2a7bf18888b71bdf9dda0770b">size</a>() );</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="comment">// This fuction must serialize the state of the object. Since there is only a single attribute, this only serializes that one.</span></div>
<div class="line"><span class="keywordtype">void</span> PtexUtilizer::Serialize( Stream &amp;<a class="code" href="./_g_lee_8h.html#ad585a1393cfa368fa9dc3d8ebff640d5">s</a> )</div>
<div class="line">{</div>
<div class="line"> <span class="keywordflow">if</span> ( s.IsNewerThan( 0, <span class="keyword">this</span> ) )</div>
<div class="line">        s == m_bIncludeMeshData;</div>
<div class="line"> <span class="keywordflow">if</span> ( s.IsNewerThan( 1, <span class="keyword">this</span> ) )</div>
<div class="line">        s == m_sFileName == m_eFormat;</div>
<div class="line">    Utilizer::Serialize( s );</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="comment">// This function initializes an instance of the FaceData structure which is used to hold data about the face.</span></div>
<div class="line">PtexUtilizer::FaceData::FaceData( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> iWidth, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> iHeight, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> iChannelCount )</div>
<div class="line">{</div>
<div class="line">    m_iWidth = iWidth;</div>
<div class="line">    m_iHeight = iHeight;</div>
<div class="line">    m_iSamplesLeft = m_iWidth*m_iHeight;</div>
<div class="line"> <span class="comment">// Allocate the array where we store the data for the face.</span></div>
<div class="line">    m_aData.resize( m_iSamplesLeft*iChannelCount );</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> PtexUtilizer::Prepare( Layout *pLayout, <span class="keyword">class</span> Sampler *pSampler )</div>
<div class="line">{</div>
<div class="line"> <span class="keyword">struct </span>Sampler::DataInfo i = Sampler()-&gt;DataInfo();</div>
<div class="line"> <span class="keywordflow">if</span> ( i.m_ePrecision == Sampler::ePrecFloatOnly )</div>
<div class="line">        m_eFormat = m_eFormat+2;</div>
<div class="line">    m_iChannelCount = pSampler-&gt;DataInfo().m_iChannelCount;</div>
<div class="line"></div>
<div class="line">    m_pLayout = <span class="keyword">dynamic_cast&lt;</span><span class="keyword">const </span>PtexLayout *<span class="keyword">&gt;</span>( pLayout );</div>
<div class="line">    Utilizer::Prepare( pLayout, pSampler );</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="comment">// This function is only used to disable integer formats when they are not allowed.</span></div>
<div class="line"><a name="_a28"></a><a class="code" href="./class_q_widget.html">QWidget</a> *PtexUtilizer::UserInterface( <span class="keywordtype">void</span> )</div>
<div class="line">{</div>
<div class="line"> <span class="keyword">struct </span>Sampler::DataInfo i = Sampler()-&gt;DataInfo();</div>
<div class="line"> <span class="keywordflow">if</span> ( i.m_ePrecision == Sampler::ePrecFloatOnly )</div>
<div class="line">    {</div>
<div class="line">        m_eFormat.Clear();</div>
<div class="line">        m_eFormat.AddItem( QObject::tr( <span class="stringliteral">"16 bit float"</span> ) );</div>
<div class="line">        m_eFormat.AddItem( QObject::tr( <span class="stringliteral">"32 bit float"</span> ) );</div>
<div class="line">        m_eFormat = 1;</div>
<div class="line">    };</div>
<div class="line"> <span class="keywordflow">return</span> Utilizer::UserInterface();</div>
<div class="line">};</div>
</div><!-- fragment --> </div><!-- contents -->
</div><!-- doc-content -->
<div class="footer-block"><a class="comments-anchor" href="../html/ac.cmtdialog.htm" target="_blank"><span class="comments-link">Please send us your comment about this page</span></a></div></div>
</div></body>
</html>
